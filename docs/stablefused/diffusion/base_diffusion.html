<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.0.0"/>
    <title>stablefused.diffusion.base_diffusion API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../diffusion.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;stablefused.diffusion</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#BaseDiffusion">BaseDiffusion</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#BaseDiffusion.device">device</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseDiffusion.torch_dtype">torch_dtype</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseDiffusion.model_id">model_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseDiffusion.tokenizer">tokenizer</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseDiffusion.text_encoder">text_encoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseDiffusion.vae">vae</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseDiffusion.unet">unet</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseDiffusion.scheduler">scheduler</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseDiffusion.vae_scale_factor">vae_scale_factor</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.to">to</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.share_components_with">share_components_with</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.set_scheduler">set_scheduler</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.enable_attention_slicing">enable_attention_slicing</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.disable_attention_slicing">disable_attention_slicing</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.enable_slicing">enable_slicing</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.disable_slicing">disable_slicing</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.enable_tiling">enable_tiling</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.disable_tiling">disable_tiling</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.validate_input">validate_input</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.embedding_to_latent">embedding_to_latent</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.random_tensor">random_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.prompt_to_embedding">prompt_to_embedding</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.classifier_free_guidance">classifier_free_guidance</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.latent_to_image">latent_to_image</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.image_to_latent">image_to_latent</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseDiffusion.resolve_output">resolve_output</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../stablefused.html">stablefused</a><wbr>.<a href="./../diffusion.html">diffusion</a><wbr>.base_diffusion    </h1>

                
                        <input id="mod-base_diffusion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-base_diffusion-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span> <span class="nn">diffusers</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>    <span class="n">AutoencoderKL</span><span class="p">,</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>    <span class="n">DiffusionPipeline</span><span class="p">,</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="p">)</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">CLIPTextModel</span><span class="p">,</span> <span class="n">CLIPTokenizer</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">stablefused.typing</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>    <span class="n">PromptType</span><span class="p">,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>    <span class="n">OutputType</span><span class="p">,</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>    <span class="n">Scheduler</span><span class="p">,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="n">SchedulerType</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="n">UNetType</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="p">)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span> <span class="nn">stablefused.utils</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>    <span class="n">denormalize</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>    <span class="n">load_model_from_cache</span><span class="p">,</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>    <span class="n">normalize</span><span class="p">,</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>    <span class="n">numpy_to_pil</span><span class="p">,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="n">numpy_to_pt</span><span class="p">,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>    <span class="n">pil_to_numpy</span><span class="p">,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="n">pt_to_numpy</span><span class="p">,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="n">resolve_scheduler</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="n">save_model_to_cache</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="p">)</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="k">class</span> <span class="nc">BaseDiffusion</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">CLIPTokenizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>        <span class="n">text_encoder</span><span class="p">:</span> <span class="n">CLIPTextModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="n">vae</span><span class="p">:</span> <span class="n">AutoencoderKL</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="n">unet</span><span class="p">:</span> <span class="n">UNetType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="n">scheduler</span><span class="p">:</span> <span class="n">SchedulerType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="n">torch_dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>        <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>        <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">torch_dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch_dtype</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">model_id</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">:</span> <span class="n">CLIPTokenizer</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">:</span> <span class="n">CLIPTextModel</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">:</span> <span class="n">AutoencoderKL</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="p">:</span> <span class="n">UNetType</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">SchedulerType</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>                <span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>                <span class="ow">or</span> <span class="n">text_encoder</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>                <span class="ow">or</span> <span class="n">vae</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>                <span class="ow">or</span> <span class="n">unet</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>                <span class="ow">or</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>            <span class="p">):</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>                    <span class="s2">&quot;Either (`model_id`) or (`tokenizer`, `text_encoder`, `vae`, `unet`, `scheduler`) must be provided.&quot;</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>                <span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">text_encoder</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">vae</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="n">unet</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">DiffusionPipeline</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>                <span class="n">model_id</span><span class="p">,</span> <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch_dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>            <span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">text_encoder</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vae</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">unet</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">scheduler</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">block_out_channels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">load_model_from_cache</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>                <span class="n">save_model_to_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">share_components_with</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BaseDiffusion&quot;</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        Move model to specified compute device.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        Parameters</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        ----------</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">        device: str</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">            The device to move the model to. Must be one of `cuda` or `cpu`.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="k">def</span> <span class="nf">share_components_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;BaseDiffusion&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">        Share components with another model. This allows for sharing of the</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">        different internal components of the model, such as the text encoder,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        VAE, and UNet. This is useful for reducing memory usage when using</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        multiple diffusion pipelines with the same checkpoint at the same time.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">        Parameters</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">        ----------</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        model: BaseDiffusion</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">            The model to share components with.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">torch_dtype</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">torch_dtype</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">text_encoder</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vae</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">unet</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">scheduler</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vae_scale_factor</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="k">def</span> <span class="nf">set_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">:</span> <span class="n">Scheduler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        Set the scheduler for the diffusion pipeline.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        Parameters</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">        ----------</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        scheduler: SchedulerType</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">            The scheduler to use for the diffusion pipeline.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">resolve_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="k">def</span> <span class="nf">enable_attention_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        Enable attention slicing. By default, the attention head is sliced in half.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">        This is a good tradeoff between memory and performance.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">        Parameters</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">        ----------</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">        slice_size: int</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">            The size of the attention slice. If -1, the attention head is sliced in</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">            half. If None, attention slicing is disabled.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="k">if</span> <span class="n">slice_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="n">slice_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">attention_head_dim</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">set_attention_slice</span><span class="p">(</span><span class="n">slice_size</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>    <span class="k">def</span> <span class="nf">disable_attention_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="sd">&quot;&quot;&quot;Disable attention slicing.&quot;&quot;&quot;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">set_attention_slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>    <span class="k">def</span> <span class="nf">enable_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        Allow tensor slicing for vae decode step. This will cause the vae to split</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">        the input tensor to compute decoding in multiple steps. This will save</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">        memory and allow for larger batch sizes, but will affect performance slightly.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">enable_slicing</span><span class="p">()</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    <span class="k">def</span> <span class="nf">disable_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="sd">&quot;&quot;&quot;Disable tensor slicing for vae decode step.&quot;&quot;&quot;</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">disable_slicing</span><span class="p">()</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>    <span class="k">def</span> <span class="nf">enable_tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        Allow tensor tiling for vae. This will cause the vae to split the input tensor</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">        into tiles to compute encoding/decoding in several steps. This will save a large</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        amount of memory and allow processing larger images, but will affect performance.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">enable_tiling</span><span class="p">()</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>    <span class="k">def</span> <span class="nf">disable_tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="sd">&quot;&quot;&quot;Disable tensor tiling for vae.&quot;&quot;&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">disable_tiling</span><span class="p">()</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>    <span class="k">def</span> <span class="nf">validate_input</span><span class="p">(</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">PromptType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="n">negative_prompt</span><span class="p">:</span> <span class="n">PromptType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="n">image_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">image_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="n">num_inference_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">        Validate input parameters.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">        TODO: This needs to be removed and improved. More checks need to be added.</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">        Parameters</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        ----------</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">        prompt: PromptType</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">            The prompt(s) to condition on.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        negative_prompt: PromptType</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">            The negative prompt(s) to condition on.</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        image_height: int</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">            The height of the image to generate.</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">        image_width: int</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">            The width of the image to generate.</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        start_step: int</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">            The step to start inference from.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        num_inference_steps: int</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">            The number of inference steps to perform.</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        strength: float</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">            The strength of the noise mixing when performing LatentWalkDiffusion.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">image_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="k">if</span> <span class="n">image_height</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">image_width</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                    <span class="s2">&quot;`image_height` and `image_width` must a multiple of 8&quot;</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">):</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>                    <span class="s2">&quot;Type of `prompt` and `negative_prompt` must be the same&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                <span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                    <span class="s2">&quot;Length of `prompt` list and `negative_prompt` list should match&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                <span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="k">if</span> <span class="n">start_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                    <span class="s2">&quot;`num_inference_steps` must be provided if `start_step` is provided&quot;</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                <span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="k">if</span> <span class="n">start_step</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">start_step</span> <span class="o">&gt;=</span> <span class="n">num_inference_steps</span><span class="p">:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                    <span class="s2">&quot;`start_step` must be in the range [0, `num_inference_steps` - 1]&quot;</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="p">)</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="k">if</span> <span class="n">strength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="k">if</span> <span class="n">strength</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">strength</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`strength` must be in the range [0.0, 1.0]&quot;</span><span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>    <span class="k">def</span> <span class="nf">embedding_to_latent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        Abstract method for converting an embedding to a latent vector. This method</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">        must be implemented by all subclasses.</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="k">pass</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">        Abstract method for performing inference. This method must be implemented</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">        by all subclasses.</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="k">pass</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>    <span class="k">def</span> <span class="nf">random_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">        Generate a random tensor of the specified shape.</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">        Parameters</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">        ----------</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">        shape: List[int] or Tuple[int]</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">            The shape of the random tensor to generate.</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        Returns</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        -------</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">            A random tensor of the specified shape on the same device and dtype</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">            as model.</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="n">rand_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">torch_dtype</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="k">return</span> <span class="n">rand_tensor</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>    <span class="k">def</span> <span class="nf">prompt_to_embedding</span><span class="p">(</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">PromptType</span><span class="p">,</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="n">negative_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PromptType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        Convert a prompt or a list of prompts into a text embedding.</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        Parameters</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        ----------</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        prompt: PromptType</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">            The prompt or a list of prompts to convert into an embedding. Used</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="sd">            for conditioning.</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        negative_prompt: Optional[PromptType]</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">            A negative prompt or a list of negative prompts, by default None.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">            Use for unconditioning. If not provided, an empty string (&#39;&#39;) will</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a><span class="sd">            be used to generate the unconditional embeddings.</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="sd">        Returns</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">        -------</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">            A text embedding generated from the given prompt(s) and, if provided,</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">            the negative prompt(s).</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="sa">f</span><span class="s2">&quot;`negative_prompt` must have the same type as `prompt` (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">), but found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt</span><span class="p">]</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>                <span class="n">negative_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="n">negative_prompt</span><span class="p">]</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`prompt` must be a string or a list of strings&quot;</span><span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="c1"># Tokenize the prompt(s)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="n">text_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="n">prompt</span><span class="p">,</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="c1"># Enable use of attention_mask if the text_encoder supports it</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;use_attention_mask&quot;</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_attention_mask</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="p">):</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">text_input</span><span class="o">.</span><span class="n">attention_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="n">attention_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="c1"># Generate text embedding</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="n">text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="n">text_input</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="c1"># Unconditioning input is an empty string if negative_prompt is not provided</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>            <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="n">negative_prompt</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="c1"># Tokenize the unconditioning input</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="n">unconditioning_input</span><span class="p">,</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="c1"># Generate unconditional embedding</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="n">unconditional_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="n">unconditioning_input</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>            <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="c1"># Concatenate unconditional and conditional embeddings</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">unconditional_embedding</span><span class="p">,</span> <span class="n">text_embedding</span><span class="p">])</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="k">return</span> <span class="n">embedding</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    <span class="k">def</span> <span class="nf">classifier_free_guidance</span><span class="p">(</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="n">noise_prediction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="n">guidance_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="n">guidance_rescale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">        Apply classifier-free guidance to noise prediction.</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">        Parameters</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">        ----------</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        noise_prediction: torch.FloatTensor</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">            The noise prediction tensor to which guidance will be applied.</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">        guidance_scale: float</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">            The scale factor for applying guidance to the noise prediction.</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">        guidance_rescale: float</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">            The rescale factor for adjusting the noise prediction based on</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">            guidance. Based on findings in Section 3.4  of [Common Diffusion</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">            Noise Schedules and Sample Steps are Flawed](https://arxiv.org/pdf/2305.08891.pdf).</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        Returns</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">        -------</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">            The noise prediction tensor after applying classifier-free guidance.</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="c1"># Perform guidance</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="n">noise_unconditional</span><span class="p">,</span> <span class="n">noise_prompt</span> <span class="o">=</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="n">noise_prediction</span> <span class="o">=</span> <span class="n">noise_unconditional</span> <span class="o">+</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="p">(</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>            <span class="n">noise_prompt</span> <span class="o">-</span> <span class="n">noise_unconditional</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="c1"># Skip computing std if guidance_rescale is 0</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="k">if</span> <span class="n">guidance_rescale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="n">std_prompt</span> <span class="o">=</span> <span class="n">noise_prompt</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                <span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_prompt</span><span class="o">.</span><span class="n">ndim</span><span class="p">)),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="n">std_prediction</span> <span class="o">=</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                <span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">ndim</span><span class="p">)),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            <span class="n">noise_prediction_rescaled</span> <span class="o">=</span> <span class="n">noise_prediction</span> <span class="o">*</span> <span class="p">(</span><span class="n">std_prompt</span> <span class="o">/</span> <span class="n">std_prediction</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="n">noise_prediction</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                <span class="n">noise_prediction</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">guidance_rescale</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="o">+</span> <span class="n">noise_prediction_rescaled</span> <span class="o">*</span> <span class="n">guidance_rescale</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="k">return</span> <span class="n">noise_prediction</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>    <span class="k">def</span> <span class="nf">latent_to_image</span><span class="p">(</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputType</span><span class="p">:</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">        Convert a latent tensor to an image in the specified output format.</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">        Parameters</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        ----------</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        latent: torch.FloatTensor</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">            The latent tensor to convert into an image.</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        output_type: str</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">            The desired output format for the image. Should be one of [`pt`, `np`, `pil`].</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        Returns</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">        -------</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        OutputType</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">            An image in the specified output format.</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;pil&quot;</span><span class="p">]:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`output_type` must be one of [`pt`, `np`, `pil`]&quot;</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="n">latent</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;pt&quot;</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="k">return</span> <span class="n">image</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="k">return</span> <span class="n">image</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">numpy_to_pil</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="k">return</span> <span class="n">image</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>    <span class="k">def</span> <span class="nf">image_to_latent</span><span class="p">(</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">        Convert an image or a list of images into a latent tensor.</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">        Parameters</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        ----------</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">        image: Union[Image.Image, List[Image.Image], np.ndarray, torch.Tensor]</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">            The input image(s) to convert into a latent tensor. Supported types are</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">            `PIL.Image.Image`, `np.ndarray`, and `torch.Tensor`.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="sd">        Returns</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="sd">        -------</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">            A latent tensor representing the input image(s).</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="p">):</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                <span class="s2">&quot;`image` type must be one of (`PIL.Image.Image`, `np.ndarray`, `torch.Tensor`). Other types are not supported yet&quot;</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>            <span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">pil_to_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span> <span class="o">=</span> <span class="n">numpy_to_pt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="n">latent</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">latent_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="k">return</span> <span class="n">latent</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    <span class="k">def</span> <span class="nf">resolve_output</span><span class="p">(</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>        <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="n">return_latent_history</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">OutputType</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputType</span><span class="p">]]:</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">        Resolve the output from the latent based on the provided output options.</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">        Parameters</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="sd">        ----------</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">        latent: torch.FloatTensor</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="sd">            The latent tensor representing the content to be resolved.</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">        output_type: str</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a><span class="sd">            The desired output format. Should be one of [`latent`, `pt`, `np`, `pil`].</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="sd">        return_latent_history: bool</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">            If True, it means that the input latent tensor contains a tensor of latent</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">            tensor for each inference step. This requires decoding each latent tensor</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">            and returning a list of images. If False, decoding occurs directly.</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">        Returns</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">        -------</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">        Union[OutputType, List[OutputType]]</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">            The resolved output based on the provided latent vector and options.</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;latent&quot;</span><span class="p">,</span> <span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;pil&quot;</span><span class="p">]:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>                <span class="s2">&quot;`output_type` must be one of [`latent`, `pt`, `np`, `pil`]&quot;</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>            <span class="k">return</span> <span class="n">latent</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="k">if</span> <span class="n">return_latent_history</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>            <span class="c1"># Transpose latent tensor from [num_steps, batch_size, *latent_dim] to</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="c1"># [batch_size, num_steps, *latent_dim].</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>            <span class="c1"># This is done so that the history of latent vectors for each prompt</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="c1"># is returned as a row instead of a column. It is what the user would</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>            <span class="c1"># intuitively expect.</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>            <span class="n">latent</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latent_to_image</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">output_type</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">latent</span><span class="p">)))</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="p">]</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>            <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;pt&quot;</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="k">elif</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                <span class="c1"># output type is &quot;pil&quot; so we can just return as a python list</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="k">pass</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_to_image</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="n">output_type</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="k">return</span> <span class="n">image</span>
</span></pre></div>


            </section>
                <section id="BaseDiffusion">
                            <input id="BaseDiffusion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BaseDiffusion</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="BaseDiffusion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion-35"><a href="#BaseDiffusion-35"><span class="linenos"> 35</span></a><span class="k">class</span> <span class="nc">BaseDiffusion</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="BaseDiffusion-36"><a href="#BaseDiffusion-36"><span class="linenos"> 36</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="BaseDiffusion-37"><a href="#BaseDiffusion-37"><span class="linenos"> 37</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion-38"><a href="#BaseDiffusion-38"><span class="linenos"> 38</span></a>        <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-39"><a href="#BaseDiffusion-39"><span class="linenos"> 39</span></a>        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">CLIPTokenizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-40"><a href="#BaseDiffusion-40"><span class="linenos"> 40</span></a>        <span class="n">text_encoder</span><span class="p">:</span> <span class="n">CLIPTextModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-41"><a href="#BaseDiffusion-41"><span class="linenos"> 41</span></a>        <span class="n">vae</span><span class="p">:</span> <span class="n">AutoencoderKL</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-42"><a href="#BaseDiffusion-42"><span class="linenos"> 42</span></a>        <span class="n">unet</span><span class="p">:</span> <span class="n">UNetType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-43"><a href="#BaseDiffusion-43"><span class="linenos"> 43</span></a>        <span class="n">scheduler</span><span class="p">:</span> <span class="n">SchedulerType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-44"><a href="#BaseDiffusion-44"><span class="linenos"> 44</span></a>        <span class="n">torch_dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
</span><span id="BaseDiffusion-45"><a href="#BaseDiffusion-45"><span class="linenos"> 45</span></a>        <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion-46"><a href="#BaseDiffusion-46"><span class="linenos"> 46</span></a>        <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BaseDiffusion-47"><a href="#BaseDiffusion-47"><span class="linenos"> 47</span></a>        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="BaseDiffusion-48"><a href="#BaseDiffusion-48"><span class="linenos"> 48</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="BaseDiffusion-49"><a href="#BaseDiffusion-49"><span class="linenos"> 49</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-50"><a href="#BaseDiffusion-50"><span class="linenos"> 50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="BaseDiffusion-51"><a href="#BaseDiffusion-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">torch_dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch_dtype</span>
</span><span id="BaseDiffusion-52"><a href="#BaseDiffusion-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">model_id</span>
</span><span id="BaseDiffusion-53"><a href="#BaseDiffusion-53"><span class="linenos"> 53</span></a>
</span><span id="BaseDiffusion-54"><a href="#BaseDiffusion-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">:</span> <span class="n">CLIPTokenizer</span>
</span><span id="BaseDiffusion-55"><a href="#BaseDiffusion-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">:</span> <span class="n">CLIPTextModel</span>
</span><span id="BaseDiffusion-56"><a href="#BaseDiffusion-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">:</span> <span class="n">AutoencoderKL</span>
</span><span id="BaseDiffusion-57"><a href="#BaseDiffusion-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="p">:</span> <span class="n">UNetType</span>
</span><span id="BaseDiffusion-58"><a href="#BaseDiffusion-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">:</span> <span class="n">SchedulerType</span>
</span><span id="BaseDiffusion-59"><a href="#BaseDiffusion-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="BaseDiffusion-60"><a href="#BaseDiffusion-60"><span class="linenos"> 60</span></a>
</span><span id="BaseDiffusion-61"><a href="#BaseDiffusion-61"><span class="linenos"> 61</span></a>        <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-62"><a href="#BaseDiffusion-62"><span class="linenos"> 62</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="BaseDiffusion-63"><a href="#BaseDiffusion-63"><span class="linenos"> 63</span></a>                <span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="BaseDiffusion-64"><a href="#BaseDiffusion-64"><span class="linenos"> 64</span></a>                <span class="ow">or</span> <span class="n">text_encoder</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="BaseDiffusion-65"><a href="#BaseDiffusion-65"><span class="linenos"> 65</span></a>                <span class="ow">or</span> <span class="n">vae</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="BaseDiffusion-66"><a href="#BaseDiffusion-66"><span class="linenos"> 66</span></a>                <span class="ow">or</span> <span class="n">unet</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="BaseDiffusion-67"><a href="#BaseDiffusion-67"><span class="linenos"> 67</span></a>                <span class="ow">or</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="BaseDiffusion-68"><a href="#BaseDiffusion-68"><span class="linenos"> 68</span></a>            <span class="p">):</span>
</span><span id="BaseDiffusion-69"><a href="#BaseDiffusion-69"><span class="linenos"> 69</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion-70"><a href="#BaseDiffusion-70"><span class="linenos"> 70</span></a>                    <span class="s2">&quot;Either (`model_id`) or (`tokenizer`, `text_encoder`, `vae`, `unet`, `scheduler`) must be provided.&quot;</span>
</span><span id="BaseDiffusion-71"><a href="#BaseDiffusion-71"><span class="linenos"> 71</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion-72"><a href="#BaseDiffusion-72"><span class="linenos"> 72</span></a>
</span><span id="BaseDiffusion-73"><a href="#BaseDiffusion-73"><span class="linenos"> 73</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</span><span id="BaseDiffusion-74"><a href="#BaseDiffusion-74"><span class="linenos"> 74</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">text_encoder</span>
</span><span id="BaseDiffusion-75"><a href="#BaseDiffusion-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">vae</span>
</span><span id="BaseDiffusion-76"><a href="#BaseDiffusion-76"><span class="linenos"> 76</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="n">unet</span>
</span><span id="BaseDiffusion-77"><a href="#BaseDiffusion-77"><span class="linenos"> 77</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span>
</span><span id="BaseDiffusion-78"><a href="#BaseDiffusion-78"><span class="linenos"> 78</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion-79"><a href="#BaseDiffusion-79"><span class="linenos"> 79</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">DiffusionPipeline</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
</span><span id="BaseDiffusion-80"><a href="#BaseDiffusion-80"><span class="linenos"> 80</span></a>                <span class="n">model_id</span><span class="p">,</span> <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch_dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="BaseDiffusion-81"><a href="#BaseDiffusion-81"><span class="linenos"> 81</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion-82"><a href="#BaseDiffusion-82"><span class="linenos"> 82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
</span><span id="BaseDiffusion-83"><a href="#BaseDiffusion-83"><span class="linenos"> 83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">text_encoder</span>
</span><span id="BaseDiffusion-84"><a href="#BaseDiffusion-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vae</span>
</span><span id="BaseDiffusion-85"><a href="#BaseDiffusion-85"><span class="linenos"> 85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">unet</span>
</span><span id="BaseDiffusion-86"><a href="#BaseDiffusion-86"><span class="linenos"> 86</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">scheduler</span>
</span><span id="BaseDiffusion-87"><a href="#BaseDiffusion-87"><span class="linenos"> 87</span></a>
</span><span id="BaseDiffusion-88"><a href="#BaseDiffusion-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion-89"><a href="#BaseDiffusion-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">block_out_channels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseDiffusion-90"><a href="#BaseDiffusion-90"><span class="linenos"> 90</span></a>
</span><span id="BaseDiffusion-91"><a href="#BaseDiffusion-91"><span class="linenos"> 91</span></a>        <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-92"><a href="#BaseDiffusion-92"><span class="linenos"> 92</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">load_model_from_cache</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="BaseDiffusion-93"><a href="#BaseDiffusion-93"><span class="linenos"> 93</span></a>            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-94"><a href="#BaseDiffusion-94"><span class="linenos"> 94</span></a>                <span class="n">save_model_to_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="BaseDiffusion-95"><a href="#BaseDiffusion-95"><span class="linenos"> 95</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion-96"><a href="#BaseDiffusion-96"><span class="linenos"> 96</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">share_components_with</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="BaseDiffusion-97"><a href="#BaseDiffusion-97"><span class="linenos"> 97</span></a>
</span><span id="BaseDiffusion-98"><a href="#BaseDiffusion-98"><span class="linenos"> 98</span></a>    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BaseDiffusion&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion-99"><a href="#BaseDiffusion-99"><span class="linenos"> 99</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-100"><a href="#BaseDiffusion-100"><span class="linenos">100</span></a><span class="sd">        Move model to specified compute device.</span>
</span><span id="BaseDiffusion-101"><a href="#BaseDiffusion-101"><span class="linenos">101</span></a>
</span><span id="BaseDiffusion-102"><a href="#BaseDiffusion-102"><span class="linenos">102</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-103"><a href="#BaseDiffusion-103"><span class="linenos">103</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-104"><a href="#BaseDiffusion-104"><span class="linenos">104</span></a><span class="sd">        device: str</span>
</span><span id="BaseDiffusion-105"><a href="#BaseDiffusion-105"><span class="linenos">105</span></a><span class="sd">            The device to move the model to. Must be one of `cuda` or `cpu`.</span>
</span><span id="BaseDiffusion-106"><a href="#BaseDiffusion-106"><span class="linenos">106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-107"><a href="#BaseDiffusion-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="BaseDiffusion-108"><a href="#BaseDiffusion-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion-109"><a href="#BaseDiffusion-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion-110"><a href="#BaseDiffusion-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion-111"><a href="#BaseDiffusion-111"><span class="linenos">111</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="BaseDiffusion-112"><a href="#BaseDiffusion-112"><span class="linenos">112</span></a>
</span><span id="BaseDiffusion-113"><a href="#BaseDiffusion-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">share_components_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;BaseDiffusion&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-114"><a href="#BaseDiffusion-114"><span class="linenos">114</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-115"><a href="#BaseDiffusion-115"><span class="linenos">115</span></a><span class="sd">        Share components with another model. This allows for sharing of the</span>
</span><span id="BaseDiffusion-116"><a href="#BaseDiffusion-116"><span class="linenos">116</span></a><span class="sd">        different internal components of the model, such as the text encoder,</span>
</span><span id="BaseDiffusion-117"><a href="#BaseDiffusion-117"><span class="linenos">117</span></a><span class="sd">        VAE, and UNet. This is useful for reducing memory usage when using</span>
</span><span id="BaseDiffusion-118"><a href="#BaseDiffusion-118"><span class="linenos">118</span></a><span class="sd">        multiple diffusion pipelines with the same checkpoint at the same time.</span>
</span><span id="BaseDiffusion-119"><a href="#BaseDiffusion-119"><span class="linenos">119</span></a>
</span><span id="BaseDiffusion-120"><a href="#BaseDiffusion-120"><span class="linenos">120</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-121"><a href="#BaseDiffusion-121"><span class="linenos">121</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-122"><a href="#BaseDiffusion-122"><span class="linenos">122</span></a><span class="sd">        model: BaseDiffusion</span>
</span><span id="BaseDiffusion-123"><a href="#BaseDiffusion-123"><span class="linenos">123</span></a><span class="sd">            The model to share components with.</span>
</span><span id="BaseDiffusion-124"><a href="#BaseDiffusion-124"><span class="linenos">124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-125"><a href="#BaseDiffusion-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span>
</span><span id="BaseDiffusion-126"><a href="#BaseDiffusion-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">torch_dtype</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">torch_dtype</span>
</span><span id="BaseDiffusion-127"><a href="#BaseDiffusion-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
</span><span id="BaseDiffusion-128"><a href="#BaseDiffusion-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">text_encoder</span>
</span><span id="BaseDiffusion-129"><a href="#BaseDiffusion-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vae</span>
</span><span id="BaseDiffusion-130"><a href="#BaseDiffusion-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">unet</span>
</span><span id="BaseDiffusion-131"><a href="#BaseDiffusion-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">scheduler</span>
</span><span id="BaseDiffusion-132"><a href="#BaseDiffusion-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vae_scale_factor</span>
</span><span id="BaseDiffusion-133"><a href="#BaseDiffusion-133"><span class="linenos">133</span></a>
</span><span id="BaseDiffusion-134"><a href="#BaseDiffusion-134"><span class="linenos">134</span></a>    <span class="k">def</span> <span class="nf">set_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">:</span> <span class="n">Scheduler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-135"><a href="#BaseDiffusion-135"><span class="linenos">135</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-136"><a href="#BaseDiffusion-136"><span class="linenos">136</span></a><span class="sd">        Set the scheduler for the diffusion pipeline.</span>
</span><span id="BaseDiffusion-137"><a href="#BaseDiffusion-137"><span class="linenos">137</span></a>
</span><span id="BaseDiffusion-138"><a href="#BaseDiffusion-138"><span class="linenos">138</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-139"><a href="#BaseDiffusion-139"><span class="linenos">139</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-140"><a href="#BaseDiffusion-140"><span class="linenos">140</span></a><span class="sd">        scheduler: SchedulerType</span>
</span><span id="BaseDiffusion-141"><a href="#BaseDiffusion-141"><span class="linenos">141</span></a><span class="sd">            The scheduler to use for the diffusion pipeline.</span>
</span><span id="BaseDiffusion-142"><a href="#BaseDiffusion-142"><span class="linenos">142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-143"><a href="#BaseDiffusion-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">resolve_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span><span id="BaseDiffusion-144"><a href="#BaseDiffusion-144"><span class="linenos">144</span></a>
</span><span id="BaseDiffusion-145"><a href="#BaseDiffusion-145"><span class="linenos">145</span></a>    <span class="k">def</span> <span class="nf">enable_attention_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-146"><a href="#BaseDiffusion-146"><span class="linenos">146</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-147"><a href="#BaseDiffusion-147"><span class="linenos">147</span></a><span class="sd">        Enable attention slicing. By default, the attention head is sliced in half.</span>
</span><span id="BaseDiffusion-148"><a href="#BaseDiffusion-148"><span class="linenos">148</span></a><span class="sd">        This is a good tradeoff between memory and performance.</span>
</span><span id="BaseDiffusion-149"><a href="#BaseDiffusion-149"><span class="linenos">149</span></a>
</span><span id="BaseDiffusion-150"><a href="#BaseDiffusion-150"><span class="linenos">150</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-151"><a href="#BaseDiffusion-151"><span class="linenos">151</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-152"><a href="#BaseDiffusion-152"><span class="linenos">152</span></a><span class="sd">        slice_size: int</span>
</span><span id="BaseDiffusion-153"><a href="#BaseDiffusion-153"><span class="linenos">153</span></a><span class="sd">            The size of the attention slice. If -1, the attention head is sliced in</span>
</span><span id="BaseDiffusion-154"><a href="#BaseDiffusion-154"><span class="linenos">154</span></a><span class="sd">            half. If None, attention slicing is disabled.</span>
</span><span id="BaseDiffusion-155"><a href="#BaseDiffusion-155"><span class="linenos">155</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-156"><a href="#BaseDiffusion-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="n">slice_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="BaseDiffusion-157"><a href="#BaseDiffusion-157"><span class="linenos">157</span></a>            <span class="n">slice_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">attention_head_dim</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="BaseDiffusion-158"><a href="#BaseDiffusion-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">set_attention_slice</span><span class="p">(</span><span class="n">slice_size</span><span class="p">)</span>
</span><span id="BaseDiffusion-159"><a href="#BaseDiffusion-159"><span class="linenos">159</span></a>
</span><span id="BaseDiffusion-160"><a href="#BaseDiffusion-160"><span class="linenos">160</span></a>    <span class="k">def</span> <span class="nf">disable_attention_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-161"><a href="#BaseDiffusion-161"><span class="linenos">161</span></a>        <span class="sd">&quot;&quot;&quot;Disable attention slicing.&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-162"><a href="#BaseDiffusion-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">set_attention_slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="BaseDiffusion-163"><a href="#BaseDiffusion-163"><span class="linenos">163</span></a>
</span><span id="BaseDiffusion-164"><a href="#BaseDiffusion-164"><span class="linenos">164</span></a>    <span class="k">def</span> <span class="nf">enable_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-165"><a href="#BaseDiffusion-165"><span class="linenos">165</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-166"><a href="#BaseDiffusion-166"><span class="linenos">166</span></a><span class="sd">        Allow tensor slicing for vae decode step. This will cause the vae to split</span>
</span><span id="BaseDiffusion-167"><a href="#BaseDiffusion-167"><span class="linenos">167</span></a><span class="sd">        the input tensor to compute decoding in multiple steps. This will save</span>
</span><span id="BaseDiffusion-168"><a href="#BaseDiffusion-168"><span class="linenos">168</span></a><span class="sd">        memory and allow for larger batch sizes, but will affect performance slightly.</span>
</span><span id="BaseDiffusion-169"><a href="#BaseDiffusion-169"><span class="linenos">169</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-170"><a href="#BaseDiffusion-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">enable_slicing</span><span class="p">()</span>
</span><span id="BaseDiffusion-171"><a href="#BaseDiffusion-171"><span class="linenos">171</span></a>
</span><span id="BaseDiffusion-172"><a href="#BaseDiffusion-172"><span class="linenos">172</span></a>    <span class="k">def</span> <span class="nf">disable_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-173"><a href="#BaseDiffusion-173"><span class="linenos">173</span></a>        <span class="sd">&quot;&quot;&quot;Disable tensor slicing for vae decode step.&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-174"><a href="#BaseDiffusion-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">disable_slicing</span><span class="p">()</span>
</span><span id="BaseDiffusion-175"><a href="#BaseDiffusion-175"><span class="linenos">175</span></a>
</span><span id="BaseDiffusion-176"><a href="#BaseDiffusion-176"><span class="linenos">176</span></a>    <span class="k">def</span> <span class="nf">enable_tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-177"><a href="#BaseDiffusion-177"><span class="linenos">177</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-178"><a href="#BaseDiffusion-178"><span class="linenos">178</span></a><span class="sd">        Allow tensor tiling for vae. This will cause the vae to split the input tensor</span>
</span><span id="BaseDiffusion-179"><a href="#BaseDiffusion-179"><span class="linenos">179</span></a><span class="sd">        into tiles to compute encoding/decoding in several steps. This will save a large</span>
</span><span id="BaseDiffusion-180"><a href="#BaseDiffusion-180"><span class="linenos">180</span></a><span class="sd">        amount of memory and allow processing larger images, but will affect performance.</span>
</span><span id="BaseDiffusion-181"><a href="#BaseDiffusion-181"><span class="linenos">181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-182"><a href="#BaseDiffusion-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">enable_tiling</span><span class="p">()</span>
</span><span id="BaseDiffusion-183"><a href="#BaseDiffusion-183"><span class="linenos">183</span></a>
</span><span id="BaseDiffusion-184"><a href="#BaseDiffusion-184"><span class="linenos">184</span></a>    <span class="k">def</span> <span class="nf">disable_tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-185"><a href="#BaseDiffusion-185"><span class="linenos">185</span></a>        <span class="sd">&quot;&quot;&quot;Disable tensor tiling for vae.&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-186"><a href="#BaseDiffusion-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">disable_tiling</span><span class="p">()</span>
</span><span id="BaseDiffusion-187"><a href="#BaseDiffusion-187"><span class="linenos">187</span></a>
</span><span id="BaseDiffusion-188"><a href="#BaseDiffusion-188"><span class="linenos">188</span></a>    <span class="nd">@staticmethod</span>
</span><span id="BaseDiffusion-189"><a href="#BaseDiffusion-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="nf">validate_input</span><span class="p">(</span>
</span><span id="BaseDiffusion-190"><a href="#BaseDiffusion-190"><span class="linenos">190</span></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">PromptType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-191"><a href="#BaseDiffusion-191"><span class="linenos">191</span></a>        <span class="n">negative_prompt</span><span class="p">:</span> <span class="n">PromptType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-192"><a href="#BaseDiffusion-192"><span class="linenos">192</span></a>        <span class="n">image_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-193"><a href="#BaseDiffusion-193"><span class="linenos">193</span></a>        <span class="n">image_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-194"><a href="#BaseDiffusion-194"><span class="linenos">194</span></a>        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-195"><a href="#BaseDiffusion-195"><span class="linenos">195</span></a>        <span class="n">num_inference_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-196"><a href="#BaseDiffusion-196"><span class="linenos">196</span></a>        <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-197"><a href="#BaseDiffusion-197"><span class="linenos">197</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-198"><a href="#BaseDiffusion-198"><span class="linenos">198</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-199"><a href="#BaseDiffusion-199"><span class="linenos">199</span></a><span class="sd">        Validate input parameters.</span>
</span><span id="BaseDiffusion-200"><a href="#BaseDiffusion-200"><span class="linenos">200</span></a><span class="sd">        TODO: This needs to be removed and improved. More checks need to be added.</span>
</span><span id="BaseDiffusion-201"><a href="#BaseDiffusion-201"><span class="linenos">201</span></a>
</span><span id="BaseDiffusion-202"><a href="#BaseDiffusion-202"><span class="linenos">202</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-203"><a href="#BaseDiffusion-203"><span class="linenos">203</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-204"><a href="#BaseDiffusion-204"><span class="linenos">204</span></a><span class="sd">        prompt: PromptType</span>
</span><span id="BaseDiffusion-205"><a href="#BaseDiffusion-205"><span class="linenos">205</span></a><span class="sd">            The prompt(s) to condition on.</span>
</span><span id="BaseDiffusion-206"><a href="#BaseDiffusion-206"><span class="linenos">206</span></a><span class="sd">        negative_prompt: PromptType</span>
</span><span id="BaseDiffusion-207"><a href="#BaseDiffusion-207"><span class="linenos">207</span></a><span class="sd">            The negative prompt(s) to condition on.</span>
</span><span id="BaseDiffusion-208"><a href="#BaseDiffusion-208"><span class="linenos">208</span></a><span class="sd">        image_height: int</span>
</span><span id="BaseDiffusion-209"><a href="#BaseDiffusion-209"><span class="linenos">209</span></a><span class="sd">            The height of the image to generate.</span>
</span><span id="BaseDiffusion-210"><a href="#BaseDiffusion-210"><span class="linenos">210</span></a><span class="sd">        image_width: int</span>
</span><span id="BaseDiffusion-211"><a href="#BaseDiffusion-211"><span class="linenos">211</span></a><span class="sd">            The width of the image to generate.</span>
</span><span id="BaseDiffusion-212"><a href="#BaseDiffusion-212"><span class="linenos">212</span></a><span class="sd">        start_step: int</span>
</span><span id="BaseDiffusion-213"><a href="#BaseDiffusion-213"><span class="linenos">213</span></a><span class="sd">            The step to start inference from.</span>
</span><span id="BaseDiffusion-214"><a href="#BaseDiffusion-214"><span class="linenos">214</span></a><span class="sd">        num_inference_steps: int</span>
</span><span id="BaseDiffusion-215"><a href="#BaseDiffusion-215"><span class="linenos">215</span></a><span class="sd">            The number of inference steps to perform.</span>
</span><span id="BaseDiffusion-216"><a href="#BaseDiffusion-216"><span class="linenos">216</span></a><span class="sd">        strength: float</span>
</span><span id="BaseDiffusion-217"><a href="#BaseDiffusion-217"><span class="linenos">217</span></a><span class="sd">            The strength of the noise mixing when performing LatentWalkDiffusion.</span>
</span><span id="BaseDiffusion-218"><a href="#BaseDiffusion-218"><span class="linenos">218</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-219"><a href="#BaseDiffusion-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="n">image_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-220"><a href="#BaseDiffusion-220"><span class="linenos">220</span></a>            <span class="k">if</span> <span class="n">image_height</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">image_width</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BaseDiffusion-221"><a href="#BaseDiffusion-221"><span class="linenos">221</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion-222"><a href="#BaseDiffusion-222"><span class="linenos">222</span></a>                    <span class="s2">&quot;`image_height` and `image_width` must a multiple of 8&quot;</span>
</span><span id="BaseDiffusion-223"><a href="#BaseDiffusion-223"><span class="linenos">223</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion-224"><a href="#BaseDiffusion-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-225"><a href="#BaseDiffusion-225"><span class="linenos">225</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">):</span>
</span><span id="BaseDiffusion-226"><a href="#BaseDiffusion-226"><span class="linenos">226</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="BaseDiffusion-227"><a href="#BaseDiffusion-227"><span class="linenos">227</span></a>                    <span class="s2">&quot;Type of `prompt` and `negative_prompt` must be the same&quot;</span>
</span><span id="BaseDiffusion-228"><a href="#BaseDiffusion-228"><span class="linenos">228</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion-229"><a href="#BaseDiffusion-229"><span class="linenos">229</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">):</span>
</span><span id="BaseDiffusion-230"><a href="#BaseDiffusion-230"><span class="linenos">230</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion-231"><a href="#BaseDiffusion-231"><span class="linenos">231</span></a>                    <span class="s2">&quot;Length of `prompt` list and `negative_prompt` list should match&quot;</span>
</span><span id="BaseDiffusion-232"><a href="#BaseDiffusion-232"><span class="linenos">232</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion-233"><a href="#BaseDiffusion-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="n">start_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-234"><a href="#BaseDiffusion-234"><span class="linenos">234</span></a>            <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-235"><a href="#BaseDiffusion-235"><span class="linenos">235</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion-236"><a href="#BaseDiffusion-236"><span class="linenos">236</span></a>                    <span class="s2">&quot;`num_inference_steps` must be provided if `start_step` is provided&quot;</span>
</span><span id="BaseDiffusion-237"><a href="#BaseDiffusion-237"><span class="linenos">237</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion-238"><a href="#BaseDiffusion-238"><span class="linenos">238</span></a>            <span class="k">if</span> <span class="n">start_step</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">start_step</span> <span class="o">&gt;=</span> <span class="n">num_inference_steps</span><span class="p">:</span>
</span><span id="BaseDiffusion-239"><a href="#BaseDiffusion-239"><span class="linenos">239</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion-240"><a href="#BaseDiffusion-240"><span class="linenos">240</span></a>                    <span class="s2">&quot;`start_step` must be in the range [0, `num_inference_steps` - 1]&quot;</span>
</span><span id="BaseDiffusion-241"><a href="#BaseDiffusion-241"><span class="linenos">241</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion-242"><a href="#BaseDiffusion-242"><span class="linenos">242</span></a>        <span class="k">if</span> <span class="n">strength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-243"><a href="#BaseDiffusion-243"><span class="linenos">243</span></a>            <span class="k">if</span> <span class="n">strength</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">strength</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BaseDiffusion-244"><a href="#BaseDiffusion-244"><span class="linenos">244</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`strength` must be in the range [0.0, 1.0]&quot;</span><span class="p">)</span>
</span><span id="BaseDiffusion-245"><a href="#BaseDiffusion-245"><span class="linenos">245</span></a>
</span><span id="BaseDiffusion-246"><a href="#BaseDiffusion-246"><span class="linenos">246</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseDiffusion-247"><a href="#BaseDiffusion-247"><span class="linenos">247</span></a>    <span class="k">def</span> <span class="nf">embedding_to_latent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="BaseDiffusion-248"><a href="#BaseDiffusion-248"><span class="linenos">248</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-249"><a href="#BaseDiffusion-249"><span class="linenos">249</span></a><span class="sd">        Abstract method for converting an embedding to a latent vector. This method</span>
</span><span id="BaseDiffusion-250"><a href="#BaseDiffusion-250"><span class="linenos">250</span></a><span class="sd">        must be implemented by all subclasses.</span>
</span><span id="BaseDiffusion-251"><a href="#BaseDiffusion-251"><span class="linenos">251</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-252"><a href="#BaseDiffusion-252"><span class="linenos">252</span></a>        <span class="k">pass</span>
</span><span id="BaseDiffusion-253"><a href="#BaseDiffusion-253"><span class="linenos">253</span></a>
</span><span id="BaseDiffusion-254"><a href="#BaseDiffusion-254"><span class="linenos">254</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseDiffusion-255"><a href="#BaseDiffusion-255"><span class="linenos">255</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="BaseDiffusion-256"><a href="#BaseDiffusion-256"><span class="linenos">256</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-257"><a href="#BaseDiffusion-257"><span class="linenos">257</span></a><span class="sd">        Abstract method for performing inference. This method must be implemented</span>
</span><span id="BaseDiffusion-258"><a href="#BaseDiffusion-258"><span class="linenos">258</span></a><span class="sd">        by all subclasses.</span>
</span><span id="BaseDiffusion-259"><a href="#BaseDiffusion-259"><span class="linenos">259</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-260"><a href="#BaseDiffusion-260"><span class="linenos">260</span></a>        <span class="k">pass</span>
</span><span id="BaseDiffusion-261"><a href="#BaseDiffusion-261"><span class="linenos">261</span></a>
</span><span id="BaseDiffusion-262"><a href="#BaseDiffusion-262"><span class="linenos">262</span></a>    <span class="k">def</span> <span class="nf">random_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="BaseDiffusion-263"><a href="#BaseDiffusion-263"><span class="linenos">263</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-264"><a href="#BaseDiffusion-264"><span class="linenos">264</span></a><span class="sd">        Generate a random tensor of the specified shape.</span>
</span><span id="BaseDiffusion-265"><a href="#BaseDiffusion-265"><span class="linenos">265</span></a>
</span><span id="BaseDiffusion-266"><a href="#BaseDiffusion-266"><span class="linenos">266</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-267"><a href="#BaseDiffusion-267"><span class="linenos">267</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-268"><a href="#BaseDiffusion-268"><span class="linenos">268</span></a><span class="sd">        shape: List[int] or Tuple[int]</span>
</span><span id="BaseDiffusion-269"><a href="#BaseDiffusion-269"><span class="linenos">269</span></a><span class="sd">            The shape of the random tensor to generate.</span>
</span><span id="BaseDiffusion-270"><a href="#BaseDiffusion-270"><span class="linenos">270</span></a>
</span><span id="BaseDiffusion-271"><a href="#BaseDiffusion-271"><span class="linenos">271</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion-272"><a href="#BaseDiffusion-272"><span class="linenos">272</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion-273"><a href="#BaseDiffusion-273"><span class="linenos">273</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="BaseDiffusion-274"><a href="#BaseDiffusion-274"><span class="linenos">274</span></a><span class="sd">            A random tensor of the specified shape on the same device and dtype</span>
</span><span id="BaseDiffusion-275"><a href="#BaseDiffusion-275"><span class="linenos">275</span></a><span class="sd">            as model.</span>
</span><span id="BaseDiffusion-276"><a href="#BaseDiffusion-276"><span class="linenos">276</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-277"><a href="#BaseDiffusion-277"><span class="linenos">277</span></a>        <span class="n">rand_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">torch_dtype</span><span class="p">)</span>
</span><span id="BaseDiffusion-278"><a href="#BaseDiffusion-278"><span class="linenos">278</span></a>        <span class="k">return</span> <span class="n">rand_tensor</span>
</span><span id="BaseDiffusion-279"><a href="#BaseDiffusion-279"><span class="linenos">279</span></a>
</span><span id="BaseDiffusion-280"><a href="#BaseDiffusion-280"><span class="linenos">280</span></a>    <span class="k">def</span> <span class="nf">prompt_to_embedding</span><span class="p">(</span>
</span><span id="BaseDiffusion-281"><a href="#BaseDiffusion-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion-282"><a href="#BaseDiffusion-282"><span class="linenos">282</span></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">PromptType</span><span class="p">,</span>
</span><span id="BaseDiffusion-283"><a href="#BaseDiffusion-283"><span class="linenos">283</span></a>        <span class="n">negative_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PromptType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion-284"><a href="#BaseDiffusion-284"><span class="linenos">284</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="BaseDiffusion-285"><a href="#BaseDiffusion-285"><span class="linenos">285</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-286"><a href="#BaseDiffusion-286"><span class="linenos">286</span></a><span class="sd">        Convert a prompt or a list of prompts into a text embedding.</span>
</span><span id="BaseDiffusion-287"><a href="#BaseDiffusion-287"><span class="linenos">287</span></a>
</span><span id="BaseDiffusion-288"><a href="#BaseDiffusion-288"><span class="linenos">288</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-289"><a href="#BaseDiffusion-289"><span class="linenos">289</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-290"><a href="#BaseDiffusion-290"><span class="linenos">290</span></a><span class="sd">        prompt: PromptType</span>
</span><span id="BaseDiffusion-291"><a href="#BaseDiffusion-291"><span class="linenos">291</span></a><span class="sd">            The prompt or a list of prompts to convert into an embedding. Used</span>
</span><span id="BaseDiffusion-292"><a href="#BaseDiffusion-292"><span class="linenos">292</span></a><span class="sd">            for conditioning.</span>
</span><span id="BaseDiffusion-293"><a href="#BaseDiffusion-293"><span class="linenos">293</span></a><span class="sd">        negative_prompt: Optional[PromptType]</span>
</span><span id="BaseDiffusion-294"><a href="#BaseDiffusion-294"><span class="linenos">294</span></a><span class="sd">            A negative prompt or a list of negative prompts, by default None.</span>
</span><span id="BaseDiffusion-295"><a href="#BaseDiffusion-295"><span class="linenos">295</span></a><span class="sd">            Use for unconditioning. If not provided, an empty string (&#39;&#39;) will</span>
</span><span id="BaseDiffusion-296"><a href="#BaseDiffusion-296"><span class="linenos">296</span></a><span class="sd">            be used to generate the unconditional embeddings.</span>
</span><span id="BaseDiffusion-297"><a href="#BaseDiffusion-297"><span class="linenos">297</span></a>
</span><span id="BaseDiffusion-298"><a href="#BaseDiffusion-298"><span class="linenos">298</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion-299"><a href="#BaseDiffusion-299"><span class="linenos">299</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion-300"><a href="#BaseDiffusion-300"><span class="linenos">300</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="BaseDiffusion-301"><a href="#BaseDiffusion-301"><span class="linenos">301</span></a><span class="sd">            A text embedding generated from the given prompt(s) and, if provided,</span>
</span><span id="BaseDiffusion-302"><a href="#BaseDiffusion-302"><span class="linenos">302</span></a><span class="sd">            the negative prompt(s).</span>
</span><span id="BaseDiffusion-303"><a href="#BaseDiffusion-303"><span class="linenos">303</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-304"><a href="#BaseDiffusion-304"><span class="linenos">304</span></a>
</span><span id="BaseDiffusion-305"><a href="#BaseDiffusion-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
</span><span id="BaseDiffusion-306"><a href="#BaseDiffusion-306"><span class="linenos">306</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="BaseDiffusion-307"><a href="#BaseDiffusion-307"><span class="linenos">307</span></a>                <span class="sa">f</span><span class="s2">&quot;`negative_prompt` must have the same type as `prompt` (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">), but found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="BaseDiffusion-308"><a href="#BaseDiffusion-308"><span class="linenos">308</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion-309"><a href="#BaseDiffusion-309"><span class="linenos">309</span></a>
</span><span id="BaseDiffusion-310"><a href="#BaseDiffusion-310"><span class="linenos">310</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="BaseDiffusion-311"><a href="#BaseDiffusion-311"><span class="linenos">311</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="BaseDiffusion-312"><a href="#BaseDiffusion-312"><span class="linenos">312</span></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt</span><span class="p">]</span>
</span><span id="BaseDiffusion-313"><a href="#BaseDiffusion-313"><span class="linenos">313</span></a>            <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-314"><a href="#BaseDiffusion-314"><span class="linenos">314</span></a>                <span class="n">negative_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="n">negative_prompt</span><span class="p">]</span>
</span><span id="BaseDiffusion-315"><a href="#BaseDiffusion-315"><span class="linenos">315</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="BaseDiffusion-316"><a href="#BaseDiffusion-316"><span class="linenos">316</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span><span id="BaseDiffusion-317"><a href="#BaseDiffusion-317"><span class="linenos">317</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion-318"><a href="#BaseDiffusion-318"><span class="linenos">318</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`prompt` must be a string or a list of strings&quot;</span><span class="p">)</span>
</span><span id="BaseDiffusion-319"><a href="#BaseDiffusion-319"><span class="linenos">319</span></a>
</span><span id="BaseDiffusion-320"><a href="#BaseDiffusion-320"><span class="linenos">320</span></a>        <span class="c1"># Tokenize the prompt(s)</span>
</span><span id="BaseDiffusion-321"><a href="#BaseDiffusion-321"><span class="linenos">321</span></a>        <span class="n">text_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
</span><span id="BaseDiffusion-322"><a href="#BaseDiffusion-322"><span class="linenos">322</span></a>            <span class="n">prompt</span><span class="p">,</span>
</span><span id="BaseDiffusion-323"><a href="#BaseDiffusion-323"><span class="linenos">323</span></a>            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion-324"><a href="#BaseDiffusion-324"><span class="linenos">324</span></a>            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
</span><span id="BaseDiffusion-325"><a href="#BaseDiffusion-325"><span class="linenos">325</span></a>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BaseDiffusion-326"><a href="#BaseDiffusion-326"><span class="linenos">326</span></a>            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion-327"><a href="#BaseDiffusion-327"><span class="linenos">327</span></a>        <span class="p">)</span>
</span><span id="BaseDiffusion-328"><a href="#BaseDiffusion-328"><span class="linenos">328</span></a>
</span><span id="BaseDiffusion-329"><a href="#BaseDiffusion-329"><span class="linenos">329</span></a>        <span class="c1"># Enable use of attention_mask if the text_encoder supports it</span>
</span><span id="BaseDiffusion-330"><a href="#BaseDiffusion-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="BaseDiffusion-331"><a href="#BaseDiffusion-331"><span class="linenos">331</span></a>            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;use_attention_mask&quot;</span><span class="p">)</span>
</span><span id="BaseDiffusion-332"><a href="#BaseDiffusion-332"><span class="linenos">332</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_attention_mask</span>
</span><span id="BaseDiffusion-333"><a href="#BaseDiffusion-333"><span class="linenos">333</span></a>        <span class="p">):</span>
</span><span id="BaseDiffusion-334"><a href="#BaseDiffusion-334"><span class="linenos">334</span></a>            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">text_input</span><span class="o">.</span><span class="n">attention_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion-335"><a href="#BaseDiffusion-335"><span class="linenos">335</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion-336"><a href="#BaseDiffusion-336"><span class="linenos">336</span></a>            <span class="n">attention_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BaseDiffusion-337"><a href="#BaseDiffusion-337"><span class="linenos">337</span></a>
</span><span id="BaseDiffusion-338"><a href="#BaseDiffusion-338"><span class="linenos">338</span></a>        <span class="c1"># Generate text embedding</span>
</span><span id="BaseDiffusion-339"><a href="#BaseDiffusion-339"><span class="linenos">339</span></a>        <span class="n">text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span>
</span><span id="BaseDiffusion-340"><a href="#BaseDiffusion-340"><span class="linenos">340</span></a>            <span class="n">text_input</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span>
</span><span id="BaseDiffusion-341"><a href="#BaseDiffusion-341"><span class="linenos">341</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BaseDiffusion-342"><a href="#BaseDiffusion-342"><span class="linenos">342</span></a>
</span><span id="BaseDiffusion-343"><a href="#BaseDiffusion-343"><span class="linenos">343</span></a>        <span class="c1"># Unconditioning input is an empty string if negative_prompt is not provided</span>
</span><span id="BaseDiffusion-344"><a href="#BaseDiffusion-344"><span class="linenos">344</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion-345"><a href="#BaseDiffusion-345"><span class="linenos">345</span></a>            <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
</span><span id="BaseDiffusion-346"><a href="#BaseDiffusion-346"><span class="linenos">346</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion-347"><a href="#BaseDiffusion-347"><span class="linenos">347</span></a>            <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="n">negative_prompt</span>
</span><span id="BaseDiffusion-348"><a href="#BaseDiffusion-348"><span class="linenos">348</span></a>
</span><span id="BaseDiffusion-349"><a href="#BaseDiffusion-349"><span class="linenos">349</span></a>        <span class="c1"># Tokenize the unconditioning input</span>
</span><span id="BaseDiffusion-350"><a href="#BaseDiffusion-350"><span class="linenos">350</span></a>        <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
</span><span id="BaseDiffusion-351"><a href="#BaseDiffusion-351"><span class="linenos">351</span></a>            <span class="n">unconditioning_input</span><span class="p">,</span>
</span><span id="BaseDiffusion-352"><a href="#BaseDiffusion-352"><span class="linenos">352</span></a>            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion-353"><a href="#BaseDiffusion-353"><span class="linenos">353</span></a>            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
</span><span id="BaseDiffusion-354"><a href="#BaseDiffusion-354"><span class="linenos">354</span></a>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BaseDiffusion-355"><a href="#BaseDiffusion-355"><span class="linenos">355</span></a>            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion-356"><a href="#BaseDiffusion-356"><span class="linenos">356</span></a>        <span class="p">)</span>
</span><span id="BaseDiffusion-357"><a href="#BaseDiffusion-357"><span class="linenos">357</span></a>
</span><span id="BaseDiffusion-358"><a href="#BaseDiffusion-358"><span class="linenos">358</span></a>        <span class="c1"># Generate unconditional embedding</span>
</span><span id="BaseDiffusion-359"><a href="#BaseDiffusion-359"><span class="linenos">359</span></a>        <span class="n">unconditional_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span>
</span><span id="BaseDiffusion-360"><a href="#BaseDiffusion-360"><span class="linenos">360</span></a>            <span class="n">unconditioning_input</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="BaseDiffusion-361"><a href="#BaseDiffusion-361"><span class="linenos">361</span></a>            <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
</span><span id="BaseDiffusion-362"><a href="#BaseDiffusion-362"><span class="linenos">362</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BaseDiffusion-363"><a href="#BaseDiffusion-363"><span class="linenos">363</span></a>
</span><span id="BaseDiffusion-364"><a href="#BaseDiffusion-364"><span class="linenos">364</span></a>        <span class="c1"># Concatenate unconditional and conditional embeddings</span>
</span><span id="BaseDiffusion-365"><a href="#BaseDiffusion-365"><span class="linenos">365</span></a>        <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">unconditional_embedding</span><span class="p">,</span> <span class="n">text_embedding</span><span class="p">])</span>
</span><span id="BaseDiffusion-366"><a href="#BaseDiffusion-366"><span class="linenos">366</span></a>        <span class="k">return</span> <span class="n">embedding</span>
</span><span id="BaseDiffusion-367"><a href="#BaseDiffusion-367"><span class="linenos">367</span></a>
</span><span id="BaseDiffusion-368"><a href="#BaseDiffusion-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">classifier_free_guidance</span><span class="p">(</span>
</span><span id="BaseDiffusion-369"><a href="#BaseDiffusion-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion-370"><a href="#BaseDiffusion-370"><span class="linenos">370</span></a>        <span class="n">noise_prediction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
</span><span id="BaseDiffusion-371"><a href="#BaseDiffusion-371"><span class="linenos">371</span></a>        <span class="n">guidance_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BaseDiffusion-372"><a href="#BaseDiffusion-372"><span class="linenos">372</span></a>        <span class="n">guidance_rescale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BaseDiffusion-373"><a href="#BaseDiffusion-373"><span class="linenos">373</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="BaseDiffusion-374"><a href="#BaseDiffusion-374"><span class="linenos">374</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-375"><a href="#BaseDiffusion-375"><span class="linenos">375</span></a><span class="sd">        Apply classifier-free guidance to noise prediction.</span>
</span><span id="BaseDiffusion-376"><a href="#BaseDiffusion-376"><span class="linenos">376</span></a>
</span><span id="BaseDiffusion-377"><a href="#BaseDiffusion-377"><span class="linenos">377</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-378"><a href="#BaseDiffusion-378"><span class="linenos">378</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-379"><a href="#BaseDiffusion-379"><span class="linenos">379</span></a><span class="sd">        noise_prediction: torch.FloatTensor</span>
</span><span id="BaseDiffusion-380"><a href="#BaseDiffusion-380"><span class="linenos">380</span></a><span class="sd">            The noise prediction tensor to which guidance will be applied.</span>
</span><span id="BaseDiffusion-381"><a href="#BaseDiffusion-381"><span class="linenos">381</span></a><span class="sd">        guidance_scale: float</span>
</span><span id="BaseDiffusion-382"><a href="#BaseDiffusion-382"><span class="linenos">382</span></a><span class="sd">            The scale factor for applying guidance to the noise prediction.</span>
</span><span id="BaseDiffusion-383"><a href="#BaseDiffusion-383"><span class="linenos">383</span></a><span class="sd">        guidance_rescale: float</span>
</span><span id="BaseDiffusion-384"><a href="#BaseDiffusion-384"><span class="linenos">384</span></a><span class="sd">            The rescale factor for adjusting the noise prediction based on</span>
</span><span id="BaseDiffusion-385"><a href="#BaseDiffusion-385"><span class="linenos">385</span></a><span class="sd">            guidance. Based on findings in Section 3.4  of [Common Diffusion</span>
</span><span id="BaseDiffusion-386"><a href="#BaseDiffusion-386"><span class="linenos">386</span></a><span class="sd">            Noise Schedules and Sample Steps are Flawed](https://arxiv.org/pdf/2305.08891.pdf).</span>
</span><span id="BaseDiffusion-387"><a href="#BaseDiffusion-387"><span class="linenos">387</span></a>
</span><span id="BaseDiffusion-388"><a href="#BaseDiffusion-388"><span class="linenos">388</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion-389"><a href="#BaseDiffusion-389"><span class="linenos">389</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion-390"><a href="#BaseDiffusion-390"><span class="linenos">390</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="BaseDiffusion-391"><a href="#BaseDiffusion-391"><span class="linenos">391</span></a><span class="sd">            The noise prediction tensor after applying classifier-free guidance.</span>
</span><span id="BaseDiffusion-392"><a href="#BaseDiffusion-392"><span class="linenos">392</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-393"><a href="#BaseDiffusion-393"><span class="linenos">393</span></a>
</span><span id="BaseDiffusion-394"><a href="#BaseDiffusion-394"><span class="linenos">394</span></a>        <span class="c1"># Perform guidance</span>
</span><span id="BaseDiffusion-395"><a href="#BaseDiffusion-395"><span class="linenos">395</span></a>        <span class="n">noise_unconditional</span><span class="p">,</span> <span class="n">noise_prompt</span> <span class="o">=</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="BaseDiffusion-396"><a href="#BaseDiffusion-396"><span class="linenos">396</span></a>        <span class="n">noise_prediction</span> <span class="o">=</span> <span class="n">noise_unconditional</span> <span class="o">+</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="p">(</span>
</span><span id="BaseDiffusion-397"><a href="#BaseDiffusion-397"><span class="linenos">397</span></a>            <span class="n">noise_prompt</span> <span class="o">-</span> <span class="n">noise_unconditional</span>
</span><span id="BaseDiffusion-398"><a href="#BaseDiffusion-398"><span class="linenos">398</span></a>        <span class="p">)</span>
</span><span id="BaseDiffusion-399"><a href="#BaseDiffusion-399"><span class="linenos">399</span></a>
</span><span id="BaseDiffusion-400"><a href="#BaseDiffusion-400"><span class="linenos">400</span></a>        <span class="c1"># Skip computing std if guidance_rescale is 0</span>
</span><span id="BaseDiffusion-401"><a href="#BaseDiffusion-401"><span class="linenos">401</span></a>        <span class="k">if</span> <span class="n">guidance_rescale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BaseDiffusion-402"><a href="#BaseDiffusion-402"><span class="linenos">402</span></a>            <span class="n">std_prompt</span> <span class="o">=</span> <span class="n">noise_prompt</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="BaseDiffusion-403"><a href="#BaseDiffusion-403"><span class="linenos">403</span></a>                <span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_prompt</span><span class="o">.</span><span class="n">ndim</span><span class="p">)),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span>
</span><span id="BaseDiffusion-404"><a href="#BaseDiffusion-404"><span class="linenos">404</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion-405"><a href="#BaseDiffusion-405"><span class="linenos">405</span></a>            <span class="n">std_prediction</span> <span class="o">=</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="BaseDiffusion-406"><a href="#BaseDiffusion-406"><span class="linenos">406</span></a>                <span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">ndim</span><span class="p">)),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span>
</span><span id="BaseDiffusion-407"><a href="#BaseDiffusion-407"><span class="linenos">407</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion-408"><a href="#BaseDiffusion-408"><span class="linenos">408</span></a>            <span class="n">noise_prediction_rescaled</span> <span class="o">=</span> <span class="n">noise_prediction</span> <span class="o">*</span> <span class="p">(</span><span class="n">std_prompt</span> <span class="o">/</span> <span class="n">std_prediction</span><span class="p">)</span>
</span><span id="BaseDiffusion-409"><a href="#BaseDiffusion-409"><span class="linenos">409</span></a>            <span class="n">noise_prediction</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseDiffusion-410"><a href="#BaseDiffusion-410"><span class="linenos">410</span></a>                <span class="n">noise_prediction</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">guidance_rescale</span><span class="p">)</span>
</span><span id="BaseDiffusion-411"><a href="#BaseDiffusion-411"><span class="linenos">411</span></a>                <span class="o">+</span> <span class="n">noise_prediction_rescaled</span> <span class="o">*</span> <span class="n">guidance_rescale</span>
</span><span id="BaseDiffusion-412"><a href="#BaseDiffusion-412"><span class="linenos">412</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion-413"><a href="#BaseDiffusion-413"><span class="linenos">413</span></a>
</span><span id="BaseDiffusion-414"><a href="#BaseDiffusion-414"><span class="linenos">414</span></a>        <span class="k">return</span> <span class="n">noise_prediction</span>
</span><span id="BaseDiffusion-415"><a href="#BaseDiffusion-415"><span class="linenos">415</span></a>
</span><span id="BaseDiffusion-416"><a href="#BaseDiffusion-416"><span class="linenos">416</span></a>    <span class="k">def</span> <span class="nf">latent_to_image</span><span class="p">(</span>
</span><span id="BaseDiffusion-417"><a href="#BaseDiffusion-417"><span class="linenos">417</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="BaseDiffusion-418"><a href="#BaseDiffusion-418"><span class="linenos">418</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputType</span><span class="p">:</span>
</span><span id="BaseDiffusion-419"><a href="#BaseDiffusion-419"><span class="linenos">419</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-420"><a href="#BaseDiffusion-420"><span class="linenos">420</span></a><span class="sd">        Convert a latent tensor to an image in the specified output format.</span>
</span><span id="BaseDiffusion-421"><a href="#BaseDiffusion-421"><span class="linenos">421</span></a>
</span><span id="BaseDiffusion-422"><a href="#BaseDiffusion-422"><span class="linenos">422</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-423"><a href="#BaseDiffusion-423"><span class="linenos">423</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-424"><a href="#BaseDiffusion-424"><span class="linenos">424</span></a><span class="sd">        latent: torch.FloatTensor</span>
</span><span id="BaseDiffusion-425"><a href="#BaseDiffusion-425"><span class="linenos">425</span></a><span class="sd">            The latent tensor to convert into an image.</span>
</span><span id="BaseDiffusion-426"><a href="#BaseDiffusion-426"><span class="linenos">426</span></a><span class="sd">        output_type: str</span>
</span><span id="BaseDiffusion-427"><a href="#BaseDiffusion-427"><span class="linenos">427</span></a><span class="sd">            The desired output format for the image. Should be one of [`pt`, `np`, `pil`].</span>
</span><span id="BaseDiffusion-428"><a href="#BaseDiffusion-428"><span class="linenos">428</span></a>
</span><span id="BaseDiffusion-429"><a href="#BaseDiffusion-429"><span class="linenos">429</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion-430"><a href="#BaseDiffusion-430"><span class="linenos">430</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion-431"><a href="#BaseDiffusion-431"><span class="linenos">431</span></a><span class="sd">        OutputType</span>
</span><span id="BaseDiffusion-432"><a href="#BaseDiffusion-432"><span class="linenos">432</span></a><span class="sd">            An image in the specified output format.</span>
</span><span id="BaseDiffusion-433"><a href="#BaseDiffusion-433"><span class="linenos">433</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-434"><a href="#BaseDiffusion-434"><span class="linenos">434</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;pil&quot;</span><span class="p">]:</span>
</span><span id="BaseDiffusion-435"><a href="#BaseDiffusion-435"><span class="linenos">435</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`output_type` must be one of [`pt`, `np`, `pil`]&quot;</span><span class="p">)</span>
</span><span id="BaseDiffusion-436"><a href="#BaseDiffusion-436"><span class="linenos">436</span></a>
</span><span id="BaseDiffusion-437"><a href="#BaseDiffusion-437"><span class="linenos">437</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span id="BaseDiffusion-438"><a href="#BaseDiffusion-438"><span class="linenos">438</span></a>            <span class="n">latent</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span>
</span><span id="BaseDiffusion-439"><a href="#BaseDiffusion-439"><span class="linenos">439</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BaseDiffusion-440"><a href="#BaseDiffusion-440"><span class="linenos">440</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion-441"><a href="#BaseDiffusion-441"><span class="linenos">441</span></a>
</span><span id="BaseDiffusion-442"><a href="#BaseDiffusion-442"><span class="linenos">442</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;pt&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion-443"><a href="#BaseDiffusion-443"><span class="linenos">443</span></a>            <span class="k">return</span> <span class="n">image</span>
</span><span id="BaseDiffusion-444"><a href="#BaseDiffusion-444"><span class="linenos">444</span></a>
</span><span id="BaseDiffusion-445"><a href="#BaseDiffusion-445"><span class="linenos">445</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion-446"><a href="#BaseDiffusion-446"><span class="linenos">446</span></a>
</span><span id="BaseDiffusion-447"><a href="#BaseDiffusion-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion-448"><a href="#BaseDiffusion-448"><span class="linenos">448</span></a>            <span class="k">return</span> <span class="n">image</span>
</span><span id="BaseDiffusion-449"><a href="#BaseDiffusion-449"><span class="linenos">449</span></a>
</span><span id="BaseDiffusion-450"><a href="#BaseDiffusion-450"><span class="linenos">450</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">numpy_to_pil</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion-451"><a href="#BaseDiffusion-451"><span class="linenos">451</span></a>        <span class="k">return</span> <span class="n">image</span>
</span><span id="BaseDiffusion-452"><a href="#BaseDiffusion-452"><span class="linenos">452</span></a>
</span><span id="BaseDiffusion-453"><a href="#BaseDiffusion-453"><span class="linenos">453</span></a>    <span class="k">def</span> <span class="nf">image_to_latent</span><span class="p">(</span>
</span><span id="BaseDiffusion-454"><a href="#BaseDiffusion-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion-455"><a href="#BaseDiffusion-455"><span class="linenos">455</span></a>        <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
</span><span id="BaseDiffusion-456"><a href="#BaseDiffusion-456"><span class="linenos">456</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="BaseDiffusion-457"><a href="#BaseDiffusion-457"><span class="linenos">457</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-458"><a href="#BaseDiffusion-458"><span class="linenos">458</span></a><span class="sd">        Convert an image or a list of images into a latent tensor.</span>
</span><span id="BaseDiffusion-459"><a href="#BaseDiffusion-459"><span class="linenos">459</span></a>
</span><span id="BaseDiffusion-460"><a href="#BaseDiffusion-460"><span class="linenos">460</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-461"><a href="#BaseDiffusion-461"><span class="linenos">461</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-462"><a href="#BaseDiffusion-462"><span class="linenos">462</span></a><span class="sd">        image: Union[Image.Image, List[Image.Image], np.ndarray, torch.Tensor]</span>
</span><span id="BaseDiffusion-463"><a href="#BaseDiffusion-463"><span class="linenos">463</span></a><span class="sd">            The input image(s) to convert into a latent tensor. Supported types are</span>
</span><span id="BaseDiffusion-464"><a href="#BaseDiffusion-464"><span class="linenos">464</span></a><span class="sd">            `PIL.Image.Image`, `np.ndarray`, and `torch.Tensor`.</span>
</span><span id="BaseDiffusion-465"><a href="#BaseDiffusion-465"><span class="linenos">465</span></a>
</span><span id="BaseDiffusion-466"><a href="#BaseDiffusion-466"><span class="linenos">466</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion-467"><a href="#BaseDiffusion-467"><span class="linenos">467</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion-468"><a href="#BaseDiffusion-468"><span class="linenos">468</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="BaseDiffusion-469"><a href="#BaseDiffusion-469"><span class="linenos">469</span></a><span class="sd">            A latent tensor representing the input image(s).</span>
</span><span id="BaseDiffusion-470"><a href="#BaseDiffusion-470"><span class="linenos">470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-471"><a href="#BaseDiffusion-471"><span class="linenos">471</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="BaseDiffusion-472"><a href="#BaseDiffusion-472"><span class="linenos">472</span></a>            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
</span><span id="BaseDiffusion-473"><a href="#BaseDiffusion-473"><span class="linenos">473</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span id="BaseDiffusion-474"><a href="#BaseDiffusion-474"><span class="linenos">474</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="BaseDiffusion-475"><a href="#BaseDiffusion-475"><span class="linenos">475</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
</span><span id="BaseDiffusion-476"><a href="#BaseDiffusion-476"><span class="linenos">476</span></a>        <span class="p">):</span>
</span><span id="BaseDiffusion-477"><a href="#BaseDiffusion-477"><span class="linenos">477</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="BaseDiffusion-478"><a href="#BaseDiffusion-478"><span class="linenos">478</span></a>                <span class="s2">&quot;`image` type must be one of (`PIL.Image.Image`, `np.ndarray`, `torch.Tensor`). Other types are not supported yet&quot;</span>
</span><span id="BaseDiffusion-479"><a href="#BaseDiffusion-479"><span class="linenos">479</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion-480"><a href="#BaseDiffusion-480"><span class="linenos">480</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
</span><span id="BaseDiffusion-481"><a href="#BaseDiffusion-481"><span class="linenos">481</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span>
</span><span id="BaseDiffusion-482"><a href="#BaseDiffusion-482"><span class="linenos">482</span></a>
</span><span id="BaseDiffusion-483"><a href="#BaseDiffusion-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
</span><span id="BaseDiffusion-484"><a href="#BaseDiffusion-484"><span class="linenos">484</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">pil_to_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion-485"><a href="#BaseDiffusion-485"><span class="linenos">485</span></a>
</span><span id="BaseDiffusion-486"><a href="#BaseDiffusion-486"><span class="linenos">486</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="BaseDiffusion-487"><a href="#BaseDiffusion-487"><span class="linenos">487</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span> <span class="o">=</span> <span class="n">numpy_to_pt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion-488"><a href="#BaseDiffusion-488"><span class="linenos">488</span></a>
</span><span id="BaseDiffusion-489"><a href="#BaseDiffusion-489"><span class="linenos">489</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion-490"><a href="#BaseDiffusion-490"><span class="linenos">490</span></a>        <span class="n">latent</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseDiffusion-491"><a href="#BaseDiffusion-491"><span class="linenos">491</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">latent_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span>
</span><span id="BaseDiffusion-492"><a href="#BaseDiffusion-492"><span class="linenos">492</span></a>        <span class="p">)</span>
</span><span id="BaseDiffusion-493"><a href="#BaseDiffusion-493"><span class="linenos">493</span></a>
</span><span id="BaseDiffusion-494"><a href="#BaseDiffusion-494"><span class="linenos">494</span></a>        <span class="k">return</span> <span class="n">latent</span>
</span><span id="BaseDiffusion-495"><a href="#BaseDiffusion-495"><span class="linenos">495</span></a>
</span><span id="BaseDiffusion-496"><a href="#BaseDiffusion-496"><span class="linenos">496</span></a>    <span class="k">def</span> <span class="nf">resolve_output</span><span class="p">(</span>
</span><span id="BaseDiffusion-497"><a href="#BaseDiffusion-497"><span class="linenos">497</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion-498"><a href="#BaseDiffusion-498"><span class="linenos">498</span></a>        <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
</span><span id="BaseDiffusion-499"><a href="#BaseDiffusion-499"><span class="linenos">499</span></a>        <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BaseDiffusion-500"><a href="#BaseDiffusion-500"><span class="linenos">500</span></a>        <span class="n">return_latent_history</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="BaseDiffusion-501"><a href="#BaseDiffusion-501"><span class="linenos">501</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">OutputType</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputType</span><span class="p">]]:</span>
</span><span id="BaseDiffusion-502"><a href="#BaseDiffusion-502"><span class="linenos">502</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-503"><a href="#BaseDiffusion-503"><span class="linenos">503</span></a><span class="sd">        Resolve the output from the latent based on the provided output options.</span>
</span><span id="BaseDiffusion-504"><a href="#BaseDiffusion-504"><span class="linenos">504</span></a>
</span><span id="BaseDiffusion-505"><a href="#BaseDiffusion-505"><span class="linenos">505</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion-506"><a href="#BaseDiffusion-506"><span class="linenos">506</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion-507"><a href="#BaseDiffusion-507"><span class="linenos">507</span></a><span class="sd">        latent: torch.FloatTensor</span>
</span><span id="BaseDiffusion-508"><a href="#BaseDiffusion-508"><span class="linenos">508</span></a><span class="sd">            The latent tensor representing the content to be resolved.</span>
</span><span id="BaseDiffusion-509"><a href="#BaseDiffusion-509"><span class="linenos">509</span></a><span class="sd">        output_type: str</span>
</span><span id="BaseDiffusion-510"><a href="#BaseDiffusion-510"><span class="linenos">510</span></a><span class="sd">            The desired output format. Should be one of [`latent`, `pt`, `np`, `pil`].</span>
</span><span id="BaseDiffusion-511"><a href="#BaseDiffusion-511"><span class="linenos">511</span></a><span class="sd">        return_latent_history: bool</span>
</span><span id="BaseDiffusion-512"><a href="#BaseDiffusion-512"><span class="linenos">512</span></a><span class="sd">            If True, it means that the input latent tensor contains a tensor of latent</span>
</span><span id="BaseDiffusion-513"><a href="#BaseDiffusion-513"><span class="linenos">513</span></a><span class="sd">            tensor for each inference step. This requires decoding each latent tensor</span>
</span><span id="BaseDiffusion-514"><a href="#BaseDiffusion-514"><span class="linenos">514</span></a><span class="sd">            and returning a list of images. If False, decoding occurs directly.</span>
</span><span id="BaseDiffusion-515"><a href="#BaseDiffusion-515"><span class="linenos">515</span></a>
</span><span id="BaseDiffusion-516"><a href="#BaseDiffusion-516"><span class="linenos">516</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion-517"><a href="#BaseDiffusion-517"><span class="linenos">517</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion-518"><a href="#BaseDiffusion-518"><span class="linenos">518</span></a><span class="sd">        Union[OutputType, List[OutputType]]</span>
</span><span id="BaseDiffusion-519"><a href="#BaseDiffusion-519"><span class="linenos">519</span></a><span class="sd">            The resolved output based on the provided latent vector and options.</span>
</span><span id="BaseDiffusion-520"><a href="#BaseDiffusion-520"><span class="linenos">520</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion-521"><a href="#BaseDiffusion-521"><span class="linenos">521</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;latent&quot;</span><span class="p">,</span> <span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;pil&quot;</span><span class="p">]:</span>
</span><span id="BaseDiffusion-522"><a href="#BaseDiffusion-522"><span class="linenos">522</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion-523"><a href="#BaseDiffusion-523"><span class="linenos">523</span></a>                <span class="s2">&quot;`output_type` must be one of [`latent`, `pt`, `np`, `pil`]&quot;</span>
</span><span id="BaseDiffusion-524"><a href="#BaseDiffusion-524"><span class="linenos">524</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion-525"><a href="#BaseDiffusion-525"><span class="linenos">525</span></a>
</span><span id="BaseDiffusion-526"><a href="#BaseDiffusion-526"><span class="linenos">526</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion-527"><a href="#BaseDiffusion-527"><span class="linenos">527</span></a>            <span class="k">return</span> <span class="n">latent</span>
</span><span id="BaseDiffusion-528"><a href="#BaseDiffusion-528"><span class="linenos">528</span></a>
</span><span id="BaseDiffusion-529"><a href="#BaseDiffusion-529"><span class="linenos">529</span></a>        <span class="k">if</span> <span class="n">return_latent_history</span><span class="p">:</span>
</span><span id="BaseDiffusion-530"><a href="#BaseDiffusion-530"><span class="linenos">530</span></a>            <span class="c1"># Transpose latent tensor from [num_steps, batch_size, *latent_dim] to</span>
</span><span id="BaseDiffusion-531"><a href="#BaseDiffusion-531"><span class="linenos">531</span></a>            <span class="c1"># [batch_size, num_steps, *latent_dim].</span>
</span><span id="BaseDiffusion-532"><a href="#BaseDiffusion-532"><span class="linenos">532</span></a>            <span class="c1"># This is done so that the history of latent vectors for each prompt</span>
</span><span id="BaseDiffusion-533"><a href="#BaseDiffusion-533"><span class="linenos">533</span></a>            <span class="c1"># is returned as a row instead of a column. It is what the user would</span>
</span><span id="BaseDiffusion-534"><a href="#BaseDiffusion-534"><span class="linenos">534</span></a>            <span class="c1"># intuitively expect.</span>
</span><span id="BaseDiffusion-535"><a href="#BaseDiffusion-535"><span class="linenos">535</span></a>            <span class="n">latent</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseDiffusion-536"><a href="#BaseDiffusion-536"><span class="linenos">536</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="BaseDiffusion-537"><a href="#BaseDiffusion-537"><span class="linenos">537</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latent_to_image</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">output_type</span><span class="p">)</span>
</span><span id="BaseDiffusion-538"><a href="#BaseDiffusion-538"><span class="linenos">538</span></a>                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">latent</span><span class="p">)))</span>
</span><span id="BaseDiffusion-539"><a href="#BaseDiffusion-539"><span class="linenos">539</span></a>            <span class="p">]</span>
</span><span id="BaseDiffusion-540"><a href="#BaseDiffusion-540"><span class="linenos">540</span></a>
</span><span id="BaseDiffusion-541"><a href="#BaseDiffusion-541"><span class="linenos">541</span></a>            <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;pt&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion-542"><a href="#BaseDiffusion-542"><span class="linenos">542</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion-543"><a href="#BaseDiffusion-543"><span class="linenos">543</span></a>            <span class="k">elif</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion-544"><a href="#BaseDiffusion-544"><span class="linenos">544</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion-545"><a href="#BaseDiffusion-545"><span class="linenos">545</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion-546"><a href="#BaseDiffusion-546"><span class="linenos">546</span></a>                <span class="c1"># output type is &quot;pil&quot; so we can just return as a python list</span>
</span><span id="BaseDiffusion-547"><a href="#BaseDiffusion-547"><span class="linenos">547</span></a>                <span class="k">pass</span>
</span><span id="BaseDiffusion-548"><a href="#BaseDiffusion-548"><span class="linenos">548</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion-549"><a href="#BaseDiffusion-549"><span class="linenos">549</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_to_image</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="n">output_type</span><span class="p">)</span>
</span><span id="BaseDiffusion-550"><a href="#BaseDiffusion-550"><span class="linenos">550</span></a>
</span><span id="BaseDiffusion-551"><a href="#BaseDiffusion-551"><span class="linenos">551</span></a>        <span class="k">return</span> <span class="n">image</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                            <div id="BaseDiffusion.device" class="classattr">
                                <div class="attr variable">
            <span class="name">device</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.device"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.torch_dtype" class="classattr">
                                <div class="attr variable">
            <span class="name">torch_dtype</span><span class="annotation">: torch.dtype</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.torch_dtype"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.model_id" class="classattr">
                                <div class="attr variable">
            <span class="name">model_id</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.model_id"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.tokenizer" class="classattr">
                                <div class="attr variable">
            <span class="name">tokenizer</span><span class="annotation">: transformers.models.clip.tokenization_clip.CLIPTokenizer</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.tokenizer"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.text_encoder" class="classattr">
                                <div class="attr variable">
            <span class="name">text_encoder</span><span class="annotation">: transformers.models.clip.modeling_clip.CLIPTextModel</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.text_encoder"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.vae" class="classattr">
                                <div class="attr variable">
            <span class="name">vae</span><span class="annotation">: diffusers.models.autoencoder_kl.AutoencoderKL</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.vae"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.unet" class="classattr">
                                <div class="attr variable">
            <span class="name">unet</span><span class="annotation">: Union[diffusers.models.unet_2d_condition.UNet2DConditionModel, diffusers.models.unet_3d_condition.UNet3DConditionModel]</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.unet"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.scheduler" class="classattr">
                                <div class="attr variable">
            <span class="name">scheduler</span><span class="annotation">: Union[diffusers.schedulers.scheduling_deis_multistep.DEISMultistepScheduler, diffusers.schedulers.scheduling_ddim.DDIMScheduler, diffusers.schedulers.scheduling_ddpm.DDPMScheduler, diffusers.schedulers.scheduling_dpmsolver_sde.DPMSolverSDEScheduler, diffusers.schedulers.scheduling_dpmsolver_multistep.DPMSolverMultistepScheduler, diffusers.schedulers.scheduling_dpmsolver_singlestep.DPMSolverSinglestepScheduler, diffusers.schedulers.scheduling_euler_ancestral_discrete.EulerAncestralDiscreteScheduler, diffusers.schedulers.scheduling_euler_discrete.EulerDiscreteScheduler, diffusers.schedulers.scheduling_heun_discrete.HeunDiscreteScheduler, diffusers.schedulers.scheduling_k_dpm_2_discrete.KDPM2DiscreteScheduler, diffusers.schedulers.scheduling_k_dpm_2_ancestral_discrete.KDPM2AncestralDiscreteScheduler, diffusers.schedulers.scheduling_lms_discrete.LMSDiscreteScheduler, diffusers.schedulers.scheduling_pndm.PNDMScheduler, diffusers.schedulers.scheduling_unipc_multistep.UniPCMultistepScheduler]</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.scheduler"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.vae_scale_factor" class="classattr">
                                <div class="attr variable">
            <span class="name">vae_scale_factor</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#BaseDiffusion.vae_scale_factor"></a>
    
    

                            </div>
                            <div id="BaseDiffusion.to" class="classattr">
                                        <input id="BaseDiffusion.to-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n"><a href="#BaseDiffusion">stablefused.diffusion.base_diffusion.BaseDiffusion</a></span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.to-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.to"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.to-98"><a href="#BaseDiffusion.to-98"><span class="linenos"> 98</span></a>    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BaseDiffusion&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion.to-99"><a href="#BaseDiffusion.to-99"><span class="linenos"> 99</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.to-100"><a href="#BaseDiffusion.to-100"><span class="linenos">100</span></a><span class="sd">        Move model to specified compute device.</span>
</span><span id="BaseDiffusion.to-101"><a href="#BaseDiffusion.to-101"><span class="linenos">101</span></a>
</span><span id="BaseDiffusion.to-102"><a href="#BaseDiffusion.to-102"><span class="linenos">102</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.to-103"><a href="#BaseDiffusion.to-103"><span class="linenos">103</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.to-104"><a href="#BaseDiffusion.to-104"><span class="linenos">104</span></a><span class="sd">        device: str</span>
</span><span id="BaseDiffusion.to-105"><a href="#BaseDiffusion.to-105"><span class="linenos">105</span></a><span class="sd">            The device to move the model to. Must be one of `cuda` or `cpu`.</span>
</span><span id="BaseDiffusion.to-106"><a href="#BaseDiffusion.to-106"><span class="linenos">106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.to-107"><a href="#BaseDiffusion.to-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="BaseDiffusion.to-108"><a href="#BaseDiffusion.to-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion.to-109"><a href="#BaseDiffusion.to-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion.to-110"><a href="#BaseDiffusion.to-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion.to-111"><a href="#BaseDiffusion.to-111"><span class="linenos">111</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Move model to specified compute device.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>device</strong> (str):
The device to move the model to. Must be one of <code>cuda</code> or <code>cpu</code>.</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.share_components_with" class="classattr">
                                        <input id="BaseDiffusion.share_components_with-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">share_components_with</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">model</span><span class="p">:</span> <span class="n"><a href="#BaseDiffusion">stablefused.diffusion.base_diffusion.BaseDiffusion</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.share_components_with-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.share_components_with"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.share_components_with-113"><a href="#BaseDiffusion.share_components_with-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">share_components_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;BaseDiffusion&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.share_components_with-114"><a href="#BaseDiffusion.share_components_with-114"><span class="linenos">114</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.share_components_with-115"><a href="#BaseDiffusion.share_components_with-115"><span class="linenos">115</span></a><span class="sd">        Share components with another model. This allows for sharing of the</span>
</span><span id="BaseDiffusion.share_components_with-116"><a href="#BaseDiffusion.share_components_with-116"><span class="linenos">116</span></a><span class="sd">        different internal components of the model, such as the text encoder,</span>
</span><span id="BaseDiffusion.share_components_with-117"><a href="#BaseDiffusion.share_components_with-117"><span class="linenos">117</span></a><span class="sd">        VAE, and UNet. This is useful for reducing memory usage when using</span>
</span><span id="BaseDiffusion.share_components_with-118"><a href="#BaseDiffusion.share_components_with-118"><span class="linenos">118</span></a><span class="sd">        multiple diffusion pipelines with the same checkpoint at the same time.</span>
</span><span id="BaseDiffusion.share_components_with-119"><a href="#BaseDiffusion.share_components_with-119"><span class="linenos">119</span></a>
</span><span id="BaseDiffusion.share_components_with-120"><a href="#BaseDiffusion.share_components_with-120"><span class="linenos">120</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.share_components_with-121"><a href="#BaseDiffusion.share_components_with-121"><span class="linenos">121</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.share_components_with-122"><a href="#BaseDiffusion.share_components_with-122"><span class="linenos">122</span></a><span class="sd">        model: BaseDiffusion</span>
</span><span id="BaseDiffusion.share_components_with-123"><a href="#BaseDiffusion.share_components_with-123"><span class="linenos">123</span></a><span class="sd">            The model to share components with.</span>
</span><span id="BaseDiffusion.share_components_with-124"><a href="#BaseDiffusion.share_components_with-124"><span class="linenos">124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.share_components_with-125"><a href="#BaseDiffusion.share_components_with-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span>
</span><span id="BaseDiffusion.share_components_with-126"><a href="#BaseDiffusion.share_components_with-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">torch_dtype</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">torch_dtype</span>
</span><span id="BaseDiffusion.share_components_with-127"><a href="#BaseDiffusion.share_components_with-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
</span><span id="BaseDiffusion.share_components_with-128"><a href="#BaseDiffusion.share_components_with-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">text_encoder</span>
</span><span id="BaseDiffusion.share_components_with-129"><a href="#BaseDiffusion.share_components_with-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vae</span>
</span><span id="BaseDiffusion.share_components_with-130"><a href="#BaseDiffusion.share_components_with-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">unet</span>
</span><span id="BaseDiffusion.share_components_with-131"><a href="#BaseDiffusion.share_components_with-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">scheduler</span>
</span><span id="BaseDiffusion.share_components_with-132"><a href="#BaseDiffusion.share_components_with-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vae_scale_factor</span>
</span></pre></div>


            <div class="docstring"><p>Share components with another model. This allows for sharing of the
different internal components of the model, such as the text encoder,
VAE, and UNet. This is useful for reducing memory usage when using
multiple diffusion pipelines with the same checkpoint at the same time.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>model</strong> (BaseDiffusion):
The model to share components with.</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.set_scheduler" class="classattr">
                                        <input id="BaseDiffusion.set_scheduler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_scheduler</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">scheduler</span><span class="p">:</span> <span class="n"><a href="../typing/enums.html#Scheduler">stablefused.typing.enums.Scheduler</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.set_scheduler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.set_scheduler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.set_scheduler-134"><a href="#BaseDiffusion.set_scheduler-134"><span class="linenos">134</span></a>    <span class="k">def</span> <span class="nf">set_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">:</span> <span class="n">Scheduler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.set_scheduler-135"><a href="#BaseDiffusion.set_scheduler-135"><span class="linenos">135</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.set_scheduler-136"><a href="#BaseDiffusion.set_scheduler-136"><span class="linenos">136</span></a><span class="sd">        Set the scheduler for the diffusion pipeline.</span>
</span><span id="BaseDiffusion.set_scheduler-137"><a href="#BaseDiffusion.set_scheduler-137"><span class="linenos">137</span></a>
</span><span id="BaseDiffusion.set_scheduler-138"><a href="#BaseDiffusion.set_scheduler-138"><span class="linenos">138</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.set_scheduler-139"><a href="#BaseDiffusion.set_scheduler-139"><span class="linenos">139</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.set_scheduler-140"><a href="#BaseDiffusion.set_scheduler-140"><span class="linenos">140</span></a><span class="sd">        scheduler: SchedulerType</span>
</span><span id="BaseDiffusion.set_scheduler-141"><a href="#BaseDiffusion.set_scheduler-141"><span class="linenos">141</span></a><span class="sd">            The scheduler to use for the diffusion pipeline.</span>
</span><span id="BaseDiffusion.set_scheduler-142"><a href="#BaseDiffusion.set_scheduler-142"><span class="linenos">142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.set_scheduler-143"><a href="#BaseDiffusion.set_scheduler-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">resolve_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Set the scheduler for the diffusion pipeline.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>scheduler</strong> (SchedulerType):
The scheduler to use for the diffusion pipeline.</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.enable_attention_slicing" class="classattr">
                                        <input id="BaseDiffusion.enable_attention_slicing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">enable_attention_slicing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">slice_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.enable_attention_slicing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.enable_attention_slicing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.enable_attention_slicing-145"><a href="#BaseDiffusion.enable_attention_slicing-145"><span class="linenos">145</span></a>    <span class="k">def</span> <span class="nf">enable_attention_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.enable_attention_slicing-146"><a href="#BaseDiffusion.enable_attention_slicing-146"><span class="linenos">146</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.enable_attention_slicing-147"><a href="#BaseDiffusion.enable_attention_slicing-147"><span class="linenos">147</span></a><span class="sd">        Enable attention slicing. By default, the attention head is sliced in half.</span>
</span><span id="BaseDiffusion.enable_attention_slicing-148"><a href="#BaseDiffusion.enable_attention_slicing-148"><span class="linenos">148</span></a><span class="sd">        This is a good tradeoff between memory and performance.</span>
</span><span id="BaseDiffusion.enable_attention_slicing-149"><a href="#BaseDiffusion.enable_attention_slicing-149"><span class="linenos">149</span></a>
</span><span id="BaseDiffusion.enable_attention_slicing-150"><a href="#BaseDiffusion.enable_attention_slicing-150"><span class="linenos">150</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.enable_attention_slicing-151"><a href="#BaseDiffusion.enable_attention_slicing-151"><span class="linenos">151</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.enable_attention_slicing-152"><a href="#BaseDiffusion.enable_attention_slicing-152"><span class="linenos">152</span></a><span class="sd">        slice_size: int</span>
</span><span id="BaseDiffusion.enable_attention_slicing-153"><a href="#BaseDiffusion.enable_attention_slicing-153"><span class="linenos">153</span></a><span class="sd">            The size of the attention slice. If -1, the attention head is sliced in</span>
</span><span id="BaseDiffusion.enable_attention_slicing-154"><a href="#BaseDiffusion.enable_attention_slicing-154"><span class="linenos">154</span></a><span class="sd">            half. If None, attention slicing is disabled.</span>
</span><span id="BaseDiffusion.enable_attention_slicing-155"><a href="#BaseDiffusion.enable_attention_slicing-155"><span class="linenos">155</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.enable_attention_slicing-156"><a href="#BaseDiffusion.enable_attention_slicing-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="n">slice_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="BaseDiffusion.enable_attention_slicing-157"><a href="#BaseDiffusion.enable_attention_slicing-157"><span class="linenos">157</span></a>            <span class="n">slice_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">attention_head_dim</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="BaseDiffusion.enable_attention_slicing-158"><a href="#BaseDiffusion.enable_attention_slicing-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">set_attention_slice</span><span class="p">(</span><span class="n">slice_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Enable attention slicing. By default, the attention head is sliced in half.
This is a good tradeoff between memory and performance.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>slice_size</strong> (int):
The size of the attention slice. If -1, the attention head is sliced in
half. If None, attention slicing is disabled.</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.disable_attention_slicing" class="classattr">
                                        <input id="BaseDiffusion.disable_attention_slicing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">disable_attention_slicing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.disable_attention_slicing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.disable_attention_slicing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.disable_attention_slicing-160"><a href="#BaseDiffusion.disable_attention_slicing-160"><span class="linenos">160</span></a>    <span class="k">def</span> <span class="nf">disable_attention_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.disable_attention_slicing-161"><a href="#BaseDiffusion.disable_attention_slicing-161"><span class="linenos">161</span></a>        <span class="sd">&quot;&quot;&quot;Disable attention slicing.&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.disable_attention_slicing-162"><a href="#BaseDiffusion.disable_attention_slicing-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">set_attention_slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Disable attention slicing.</p>
</div>


                            </div>
                            <div id="BaseDiffusion.enable_slicing" class="classattr">
                                        <input id="BaseDiffusion.enable_slicing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">enable_slicing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.enable_slicing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.enable_slicing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.enable_slicing-164"><a href="#BaseDiffusion.enable_slicing-164"><span class="linenos">164</span></a>    <span class="k">def</span> <span class="nf">enable_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.enable_slicing-165"><a href="#BaseDiffusion.enable_slicing-165"><span class="linenos">165</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.enable_slicing-166"><a href="#BaseDiffusion.enable_slicing-166"><span class="linenos">166</span></a><span class="sd">        Allow tensor slicing for vae decode step. This will cause the vae to split</span>
</span><span id="BaseDiffusion.enable_slicing-167"><a href="#BaseDiffusion.enable_slicing-167"><span class="linenos">167</span></a><span class="sd">        the input tensor to compute decoding in multiple steps. This will save</span>
</span><span id="BaseDiffusion.enable_slicing-168"><a href="#BaseDiffusion.enable_slicing-168"><span class="linenos">168</span></a><span class="sd">        memory and allow for larger batch sizes, but will affect performance slightly.</span>
</span><span id="BaseDiffusion.enable_slicing-169"><a href="#BaseDiffusion.enable_slicing-169"><span class="linenos">169</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.enable_slicing-170"><a href="#BaseDiffusion.enable_slicing-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">enable_slicing</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Allow tensor slicing for vae decode step. This will cause the vae to split
the input tensor to compute decoding in multiple steps. This will save
memory and allow for larger batch sizes, but will affect performance slightly.</p>
</div>


                            </div>
                            <div id="BaseDiffusion.disable_slicing" class="classattr">
                                        <input id="BaseDiffusion.disable_slicing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">disable_slicing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.disable_slicing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.disable_slicing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.disable_slicing-172"><a href="#BaseDiffusion.disable_slicing-172"><span class="linenos">172</span></a>    <span class="k">def</span> <span class="nf">disable_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.disable_slicing-173"><a href="#BaseDiffusion.disable_slicing-173"><span class="linenos">173</span></a>        <span class="sd">&quot;&quot;&quot;Disable tensor slicing for vae decode step.&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.disable_slicing-174"><a href="#BaseDiffusion.disable_slicing-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">disable_slicing</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Disable tensor slicing for vae decode step.</p>
</div>


                            </div>
                            <div id="BaseDiffusion.enable_tiling" class="classattr">
                                        <input id="BaseDiffusion.enable_tiling-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">enable_tiling</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.enable_tiling-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.enable_tiling"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.enable_tiling-176"><a href="#BaseDiffusion.enable_tiling-176"><span class="linenos">176</span></a>    <span class="k">def</span> <span class="nf">enable_tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.enable_tiling-177"><a href="#BaseDiffusion.enable_tiling-177"><span class="linenos">177</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.enable_tiling-178"><a href="#BaseDiffusion.enable_tiling-178"><span class="linenos">178</span></a><span class="sd">        Allow tensor tiling for vae. This will cause the vae to split the input tensor</span>
</span><span id="BaseDiffusion.enable_tiling-179"><a href="#BaseDiffusion.enable_tiling-179"><span class="linenos">179</span></a><span class="sd">        into tiles to compute encoding/decoding in several steps. This will save a large</span>
</span><span id="BaseDiffusion.enable_tiling-180"><a href="#BaseDiffusion.enable_tiling-180"><span class="linenos">180</span></a><span class="sd">        amount of memory and allow processing larger images, but will affect performance.</span>
</span><span id="BaseDiffusion.enable_tiling-181"><a href="#BaseDiffusion.enable_tiling-181"><span class="linenos">181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.enable_tiling-182"><a href="#BaseDiffusion.enable_tiling-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">enable_tiling</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Allow tensor tiling for vae. This will cause the vae to split the input tensor
into tiles to compute encoding/decoding in several steps. This will save a large
amount of memory and allow processing larger images, but will affect performance.</p>
</div>


                            </div>
                            <div id="BaseDiffusion.disable_tiling" class="classattr">
                                        <input id="BaseDiffusion.disable_tiling-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">disable_tiling</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.disable_tiling-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.disable_tiling"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.disable_tiling-184"><a href="#BaseDiffusion.disable_tiling-184"><span class="linenos">184</span></a>    <span class="k">def</span> <span class="nf">disable_tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.disable_tiling-185"><a href="#BaseDiffusion.disable_tiling-185"><span class="linenos">185</span></a>        <span class="sd">&quot;&quot;&quot;Disable tensor tiling for vae.&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.disable_tiling-186"><a href="#BaseDiffusion.disable_tiling-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">disable_tiling</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Disable tensor tiling for vae.</p>
</div>


                            </div>
                            <div id="BaseDiffusion.validate_input" class="classattr">
                                        <input id="BaseDiffusion.validate_input-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">validate_input</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">negative_prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">image_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">image_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">num_inference_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.validate_input-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.validate_input"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.validate_input-188"><a href="#BaseDiffusion.validate_input-188"><span class="linenos">188</span></a>    <span class="nd">@staticmethod</span>
</span><span id="BaseDiffusion.validate_input-189"><a href="#BaseDiffusion.validate_input-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="nf">validate_input</span><span class="p">(</span>
</span><span id="BaseDiffusion.validate_input-190"><a href="#BaseDiffusion.validate_input-190"><span class="linenos">190</span></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">PromptType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion.validate_input-191"><a href="#BaseDiffusion.validate_input-191"><span class="linenos">191</span></a>        <span class="n">negative_prompt</span><span class="p">:</span> <span class="n">PromptType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion.validate_input-192"><a href="#BaseDiffusion.validate_input-192"><span class="linenos">192</span></a>        <span class="n">image_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion.validate_input-193"><a href="#BaseDiffusion.validate_input-193"><span class="linenos">193</span></a>        <span class="n">image_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion.validate_input-194"><a href="#BaseDiffusion.validate_input-194"><span class="linenos">194</span></a>        <span class="n">start_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion.validate_input-195"><a href="#BaseDiffusion.validate_input-195"><span class="linenos">195</span></a>        <span class="n">num_inference_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion.validate_input-196"><a href="#BaseDiffusion.validate_input-196"><span class="linenos">196</span></a>        <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion.validate_input-197"><a href="#BaseDiffusion.validate_input-197"><span class="linenos">197</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-198"><a href="#BaseDiffusion.validate_input-198"><span class="linenos">198</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.validate_input-199"><a href="#BaseDiffusion.validate_input-199"><span class="linenos">199</span></a><span class="sd">        Validate input parameters.</span>
</span><span id="BaseDiffusion.validate_input-200"><a href="#BaseDiffusion.validate_input-200"><span class="linenos">200</span></a><span class="sd">        TODO: This needs to be removed and improved. More checks need to be added.</span>
</span><span id="BaseDiffusion.validate_input-201"><a href="#BaseDiffusion.validate_input-201"><span class="linenos">201</span></a>
</span><span id="BaseDiffusion.validate_input-202"><a href="#BaseDiffusion.validate_input-202"><span class="linenos">202</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.validate_input-203"><a href="#BaseDiffusion.validate_input-203"><span class="linenos">203</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.validate_input-204"><a href="#BaseDiffusion.validate_input-204"><span class="linenos">204</span></a><span class="sd">        prompt: PromptType</span>
</span><span id="BaseDiffusion.validate_input-205"><a href="#BaseDiffusion.validate_input-205"><span class="linenos">205</span></a><span class="sd">            The prompt(s) to condition on.</span>
</span><span id="BaseDiffusion.validate_input-206"><a href="#BaseDiffusion.validate_input-206"><span class="linenos">206</span></a><span class="sd">        negative_prompt: PromptType</span>
</span><span id="BaseDiffusion.validate_input-207"><a href="#BaseDiffusion.validate_input-207"><span class="linenos">207</span></a><span class="sd">            The negative prompt(s) to condition on.</span>
</span><span id="BaseDiffusion.validate_input-208"><a href="#BaseDiffusion.validate_input-208"><span class="linenos">208</span></a><span class="sd">        image_height: int</span>
</span><span id="BaseDiffusion.validate_input-209"><a href="#BaseDiffusion.validate_input-209"><span class="linenos">209</span></a><span class="sd">            The height of the image to generate.</span>
</span><span id="BaseDiffusion.validate_input-210"><a href="#BaseDiffusion.validate_input-210"><span class="linenos">210</span></a><span class="sd">        image_width: int</span>
</span><span id="BaseDiffusion.validate_input-211"><a href="#BaseDiffusion.validate_input-211"><span class="linenos">211</span></a><span class="sd">            The width of the image to generate.</span>
</span><span id="BaseDiffusion.validate_input-212"><a href="#BaseDiffusion.validate_input-212"><span class="linenos">212</span></a><span class="sd">        start_step: int</span>
</span><span id="BaseDiffusion.validate_input-213"><a href="#BaseDiffusion.validate_input-213"><span class="linenos">213</span></a><span class="sd">            The step to start inference from.</span>
</span><span id="BaseDiffusion.validate_input-214"><a href="#BaseDiffusion.validate_input-214"><span class="linenos">214</span></a><span class="sd">        num_inference_steps: int</span>
</span><span id="BaseDiffusion.validate_input-215"><a href="#BaseDiffusion.validate_input-215"><span class="linenos">215</span></a><span class="sd">            The number of inference steps to perform.</span>
</span><span id="BaseDiffusion.validate_input-216"><a href="#BaseDiffusion.validate_input-216"><span class="linenos">216</span></a><span class="sd">        strength: float</span>
</span><span id="BaseDiffusion.validate_input-217"><a href="#BaseDiffusion.validate_input-217"><span class="linenos">217</span></a><span class="sd">            The strength of the noise mixing when performing LatentWalkDiffusion.</span>
</span><span id="BaseDiffusion.validate_input-218"><a href="#BaseDiffusion.validate_input-218"><span class="linenos">218</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.validate_input-219"><a href="#BaseDiffusion.validate_input-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="n">image_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-220"><a href="#BaseDiffusion.validate_input-220"><span class="linenos">220</span></a>            <span class="k">if</span> <span class="n">image_height</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">image_width</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-221"><a href="#BaseDiffusion.validate_input-221"><span class="linenos">221</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion.validate_input-222"><a href="#BaseDiffusion.validate_input-222"><span class="linenos">222</span></a>                    <span class="s2">&quot;`image_height` and `image_width` must a multiple of 8&quot;</span>
</span><span id="BaseDiffusion.validate_input-223"><a href="#BaseDiffusion.validate_input-223"><span class="linenos">223</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion.validate_input-224"><a href="#BaseDiffusion.validate_input-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-225"><a href="#BaseDiffusion.validate_input-225"><span class="linenos">225</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">):</span>
</span><span id="BaseDiffusion.validate_input-226"><a href="#BaseDiffusion.validate_input-226"><span class="linenos">226</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="BaseDiffusion.validate_input-227"><a href="#BaseDiffusion.validate_input-227"><span class="linenos">227</span></a>                    <span class="s2">&quot;Type of `prompt` and `negative_prompt` must be the same&quot;</span>
</span><span id="BaseDiffusion.validate_input-228"><a href="#BaseDiffusion.validate_input-228"><span class="linenos">228</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion.validate_input-229"><a href="#BaseDiffusion.validate_input-229"><span class="linenos">229</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">):</span>
</span><span id="BaseDiffusion.validate_input-230"><a href="#BaseDiffusion.validate_input-230"><span class="linenos">230</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion.validate_input-231"><a href="#BaseDiffusion.validate_input-231"><span class="linenos">231</span></a>                    <span class="s2">&quot;Length of `prompt` list and `negative_prompt` list should match&quot;</span>
</span><span id="BaseDiffusion.validate_input-232"><a href="#BaseDiffusion.validate_input-232"><span class="linenos">232</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion.validate_input-233"><a href="#BaseDiffusion.validate_input-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="n">start_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-234"><a href="#BaseDiffusion.validate_input-234"><span class="linenos">234</span></a>            <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-235"><a href="#BaseDiffusion.validate_input-235"><span class="linenos">235</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion.validate_input-236"><a href="#BaseDiffusion.validate_input-236"><span class="linenos">236</span></a>                    <span class="s2">&quot;`num_inference_steps` must be provided if `start_step` is provided&quot;</span>
</span><span id="BaseDiffusion.validate_input-237"><a href="#BaseDiffusion.validate_input-237"><span class="linenos">237</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion.validate_input-238"><a href="#BaseDiffusion.validate_input-238"><span class="linenos">238</span></a>            <span class="k">if</span> <span class="n">start_step</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">start_step</span> <span class="o">&gt;=</span> <span class="n">num_inference_steps</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-239"><a href="#BaseDiffusion.validate_input-239"><span class="linenos">239</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion.validate_input-240"><a href="#BaseDiffusion.validate_input-240"><span class="linenos">240</span></a>                    <span class="s2">&quot;`start_step` must be in the range [0, `num_inference_steps` - 1]&quot;</span>
</span><span id="BaseDiffusion.validate_input-241"><a href="#BaseDiffusion.validate_input-241"><span class="linenos">241</span></a>                <span class="p">)</span>
</span><span id="BaseDiffusion.validate_input-242"><a href="#BaseDiffusion.validate_input-242"><span class="linenos">242</span></a>        <span class="k">if</span> <span class="n">strength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-243"><a href="#BaseDiffusion.validate_input-243"><span class="linenos">243</span></a>            <span class="k">if</span> <span class="n">strength</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">strength</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BaseDiffusion.validate_input-244"><a href="#BaseDiffusion.validate_input-244"><span class="linenos">244</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`strength` must be in the range [0.0, 1.0]&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Validate input parameters.
TODO: This needs to be removed and improved. More checks need to be added.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>prompt</strong> (PromptType):
The prompt(s) to condition on.</li>
<li><strong>negative_prompt</strong> (PromptType):
The negative prompt(s) to condition on.</li>
<li><strong>image_height</strong> (int):
The height of the image to generate.</li>
<li><strong>image_width</strong> (int):
The width of the image to generate.</li>
<li><strong>start_step</strong> (int):
The step to start inference from.</li>
<li><strong>num_inference_steps</strong> (int):
The number of inference steps to perform.</li>
<li><strong>strength</strong> (float):
The strength of the noise mixing when performing LatentWalkDiffusion.</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.embedding_to_latent" class="classattr">
                                        <input id="BaseDiffusion.embedding_to_latent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">embedding_to_latent</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="n">Any</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.embedding_to_latent-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.embedding_to_latent"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.embedding_to_latent-246"><a href="#BaseDiffusion.embedding_to_latent-246"><span class="linenos">246</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseDiffusion.embedding_to_latent-247"><a href="#BaseDiffusion.embedding_to_latent-247"><span class="linenos">247</span></a>    <span class="k">def</span> <span class="nf">embedding_to_latent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="BaseDiffusion.embedding_to_latent-248"><a href="#BaseDiffusion.embedding_to_latent-248"><span class="linenos">248</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.embedding_to_latent-249"><a href="#BaseDiffusion.embedding_to_latent-249"><span class="linenos">249</span></a><span class="sd">        Abstract method for converting an embedding to a latent vector. This method</span>
</span><span id="BaseDiffusion.embedding_to_latent-250"><a href="#BaseDiffusion.embedding_to_latent-250"><span class="linenos">250</span></a><span class="sd">        must be implemented by all subclasses.</span>
</span><span id="BaseDiffusion.embedding_to_latent-251"><a href="#BaseDiffusion.embedding_to_latent-251"><span class="linenos">251</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.embedding_to_latent-252"><a href="#BaseDiffusion.embedding_to_latent-252"><span class="linenos">252</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Abstract method for converting an embedding to a latent vector. This method
must be implemented by all subclasses.</p>
</div>


                            </div>
                            <div id="BaseDiffusion.random_tensor" class="classattr">
                                        <input id="BaseDiffusion.random_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">random_tensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.random_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.random_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.random_tensor-262"><a href="#BaseDiffusion.random_tensor-262"><span class="linenos">262</span></a>    <span class="k">def</span> <span class="nf">random_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="BaseDiffusion.random_tensor-263"><a href="#BaseDiffusion.random_tensor-263"><span class="linenos">263</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.random_tensor-264"><a href="#BaseDiffusion.random_tensor-264"><span class="linenos">264</span></a><span class="sd">        Generate a random tensor of the specified shape.</span>
</span><span id="BaseDiffusion.random_tensor-265"><a href="#BaseDiffusion.random_tensor-265"><span class="linenos">265</span></a>
</span><span id="BaseDiffusion.random_tensor-266"><a href="#BaseDiffusion.random_tensor-266"><span class="linenos">266</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.random_tensor-267"><a href="#BaseDiffusion.random_tensor-267"><span class="linenos">267</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.random_tensor-268"><a href="#BaseDiffusion.random_tensor-268"><span class="linenos">268</span></a><span class="sd">        shape: List[int] or Tuple[int]</span>
</span><span id="BaseDiffusion.random_tensor-269"><a href="#BaseDiffusion.random_tensor-269"><span class="linenos">269</span></a><span class="sd">            The shape of the random tensor to generate.</span>
</span><span id="BaseDiffusion.random_tensor-270"><a href="#BaseDiffusion.random_tensor-270"><span class="linenos">270</span></a>
</span><span id="BaseDiffusion.random_tensor-271"><a href="#BaseDiffusion.random_tensor-271"><span class="linenos">271</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion.random_tensor-272"><a href="#BaseDiffusion.random_tensor-272"><span class="linenos">272</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion.random_tensor-273"><a href="#BaseDiffusion.random_tensor-273"><span class="linenos">273</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="BaseDiffusion.random_tensor-274"><a href="#BaseDiffusion.random_tensor-274"><span class="linenos">274</span></a><span class="sd">            A random tensor of the specified shape on the same device and dtype</span>
</span><span id="BaseDiffusion.random_tensor-275"><a href="#BaseDiffusion.random_tensor-275"><span class="linenos">275</span></a><span class="sd">            as model.</span>
</span><span id="BaseDiffusion.random_tensor-276"><a href="#BaseDiffusion.random_tensor-276"><span class="linenos">276</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.random_tensor-277"><a href="#BaseDiffusion.random_tensor-277"><span class="linenos">277</span></a>        <span class="n">rand_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">torch_dtype</span><span class="p">)</span>
</span><span id="BaseDiffusion.random_tensor-278"><a href="#BaseDiffusion.random_tensor-278"><span class="linenos">278</span></a>        <span class="k">return</span> <span class="n">rand_tensor</span>
</span></pre></div>


            <div class="docstring"><p>Generate a random tensor of the specified shape.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>shape</strong> (List[int] or Tuple[int]):
The shape of the random tensor to generate.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>torch.FloatTensor</strong>: A random tensor of the specified shape on the same device and dtype
as model.</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.prompt_to_embedding" class="classattr">
                                        <input id="BaseDiffusion.prompt_to_embedding-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prompt_to_embedding</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>,</span><span class="param">	<span class="n">negative_prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.prompt_to_embedding-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.prompt_to_embedding"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.prompt_to_embedding-280"><a href="#BaseDiffusion.prompt_to_embedding-280"><span class="linenos">280</span></a>    <span class="k">def</span> <span class="nf">prompt_to_embedding</span><span class="p">(</span>
</span><span id="BaseDiffusion.prompt_to_embedding-281"><a href="#BaseDiffusion.prompt_to_embedding-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-282"><a href="#BaseDiffusion.prompt_to_embedding-282"><span class="linenos">282</span></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">PromptType</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-283"><a href="#BaseDiffusion.prompt_to_embedding-283"><span class="linenos">283</span></a>        <span class="n">negative_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PromptType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-284"><a href="#BaseDiffusion.prompt_to_embedding-284"><span class="linenos">284</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="BaseDiffusion.prompt_to_embedding-285"><a href="#BaseDiffusion.prompt_to_embedding-285"><span class="linenos">285</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.prompt_to_embedding-286"><a href="#BaseDiffusion.prompt_to_embedding-286"><span class="linenos">286</span></a><span class="sd">        Convert a prompt or a list of prompts into a text embedding.</span>
</span><span id="BaseDiffusion.prompt_to_embedding-287"><a href="#BaseDiffusion.prompt_to_embedding-287"><span class="linenos">287</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-288"><a href="#BaseDiffusion.prompt_to_embedding-288"><span class="linenos">288</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.prompt_to_embedding-289"><a href="#BaseDiffusion.prompt_to_embedding-289"><span class="linenos">289</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.prompt_to_embedding-290"><a href="#BaseDiffusion.prompt_to_embedding-290"><span class="linenos">290</span></a><span class="sd">        prompt: PromptType</span>
</span><span id="BaseDiffusion.prompt_to_embedding-291"><a href="#BaseDiffusion.prompt_to_embedding-291"><span class="linenos">291</span></a><span class="sd">            The prompt or a list of prompts to convert into an embedding. Used</span>
</span><span id="BaseDiffusion.prompt_to_embedding-292"><a href="#BaseDiffusion.prompt_to_embedding-292"><span class="linenos">292</span></a><span class="sd">            for conditioning.</span>
</span><span id="BaseDiffusion.prompt_to_embedding-293"><a href="#BaseDiffusion.prompt_to_embedding-293"><span class="linenos">293</span></a><span class="sd">        negative_prompt: Optional[PromptType]</span>
</span><span id="BaseDiffusion.prompt_to_embedding-294"><a href="#BaseDiffusion.prompt_to_embedding-294"><span class="linenos">294</span></a><span class="sd">            A negative prompt or a list of negative prompts, by default None.</span>
</span><span id="BaseDiffusion.prompt_to_embedding-295"><a href="#BaseDiffusion.prompt_to_embedding-295"><span class="linenos">295</span></a><span class="sd">            Use for unconditioning. If not provided, an empty string (&#39;&#39;) will</span>
</span><span id="BaseDiffusion.prompt_to_embedding-296"><a href="#BaseDiffusion.prompt_to_embedding-296"><span class="linenos">296</span></a><span class="sd">            be used to generate the unconditional embeddings.</span>
</span><span id="BaseDiffusion.prompt_to_embedding-297"><a href="#BaseDiffusion.prompt_to_embedding-297"><span class="linenos">297</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-298"><a href="#BaseDiffusion.prompt_to_embedding-298"><span class="linenos">298</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion.prompt_to_embedding-299"><a href="#BaseDiffusion.prompt_to_embedding-299"><span class="linenos">299</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion.prompt_to_embedding-300"><a href="#BaseDiffusion.prompt_to_embedding-300"><span class="linenos">300</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="BaseDiffusion.prompt_to_embedding-301"><a href="#BaseDiffusion.prompt_to_embedding-301"><span class="linenos">301</span></a><span class="sd">            A text embedding generated from the given prompt(s) and, if provided,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-302"><a href="#BaseDiffusion.prompt_to_embedding-302"><span class="linenos">302</span></a><span class="sd">            the negative prompt(s).</span>
</span><span id="BaseDiffusion.prompt_to_embedding-303"><a href="#BaseDiffusion.prompt_to_embedding-303"><span class="linenos">303</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.prompt_to_embedding-304"><a href="#BaseDiffusion.prompt_to_embedding-304"><span class="linenos">304</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-305"><a href="#BaseDiffusion.prompt_to_embedding-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
</span><span id="BaseDiffusion.prompt_to_embedding-306"><a href="#BaseDiffusion.prompt_to_embedding-306"><span class="linenos">306</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="BaseDiffusion.prompt_to_embedding-307"><a href="#BaseDiffusion.prompt_to_embedding-307"><span class="linenos">307</span></a>                <span class="sa">f</span><span class="s2">&quot;`negative_prompt` must have the same type as `prompt` (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">), but found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">negative_prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="BaseDiffusion.prompt_to_embedding-308"><a href="#BaseDiffusion.prompt_to_embedding-308"><span class="linenos">308</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion.prompt_to_embedding-309"><a href="#BaseDiffusion.prompt_to_embedding-309"><span class="linenos">309</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-310"><a href="#BaseDiffusion.prompt_to_embedding-310"><span class="linenos">310</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="BaseDiffusion.prompt_to_embedding-311"><a href="#BaseDiffusion.prompt_to_embedding-311"><span class="linenos">311</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="BaseDiffusion.prompt_to_embedding-312"><a href="#BaseDiffusion.prompt_to_embedding-312"><span class="linenos">312</span></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt</span><span class="p">]</span>
</span><span id="BaseDiffusion.prompt_to_embedding-313"><a href="#BaseDiffusion.prompt_to_embedding-313"><span class="linenos">313</span></a>            <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.prompt_to_embedding-314"><a href="#BaseDiffusion.prompt_to_embedding-314"><span class="linenos">314</span></a>                <span class="n">negative_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="n">negative_prompt</span><span class="p">]</span>
</span><span id="BaseDiffusion.prompt_to_embedding-315"><a href="#BaseDiffusion.prompt_to_embedding-315"><span class="linenos">315</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="BaseDiffusion.prompt_to_embedding-316"><a href="#BaseDiffusion.prompt_to_embedding-316"><span class="linenos">316</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span><span id="BaseDiffusion.prompt_to_embedding-317"><a href="#BaseDiffusion.prompt_to_embedding-317"><span class="linenos">317</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion.prompt_to_embedding-318"><a href="#BaseDiffusion.prompt_to_embedding-318"><span class="linenos">318</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`prompt` must be a string or a list of strings&quot;</span><span class="p">)</span>
</span><span id="BaseDiffusion.prompt_to_embedding-319"><a href="#BaseDiffusion.prompt_to_embedding-319"><span class="linenos">319</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-320"><a href="#BaseDiffusion.prompt_to_embedding-320"><span class="linenos">320</span></a>        <span class="c1"># Tokenize the prompt(s)</span>
</span><span id="BaseDiffusion.prompt_to_embedding-321"><a href="#BaseDiffusion.prompt_to_embedding-321"><span class="linenos">321</span></a>        <span class="n">text_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
</span><span id="BaseDiffusion.prompt_to_embedding-322"><a href="#BaseDiffusion.prompt_to_embedding-322"><span class="linenos">322</span></a>            <span class="n">prompt</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-323"><a href="#BaseDiffusion.prompt_to_embedding-323"><span class="linenos">323</span></a>            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-324"><a href="#BaseDiffusion.prompt_to_embedding-324"><span class="linenos">324</span></a>            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-325"><a href="#BaseDiffusion.prompt_to_embedding-325"><span class="linenos">325</span></a>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-326"><a href="#BaseDiffusion.prompt_to_embedding-326"><span class="linenos">326</span></a>            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-327"><a href="#BaseDiffusion.prompt_to_embedding-327"><span class="linenos">327</span></a>        <span class="p">)</span>
</span><span id="BaseDiffusion.prompt_to_embedding-328"><a href="#BaseDiffusion.prompt_to_embedding-328"><span class="linenos">328</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-329"><a href="#BaseDiffusion.prompt_to_embedding-329"><span class="linenos">329</span></a>        <span class="c1"># Enable use of attention_mask if the text_encoder supports it</span>
</span><span id="BaseDiffusion.prompt_to_embedding-330"><a href="#BaseDiffusion.prompt_to_embedding-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="BaseDiffusion.prompt_to_embedding-331"><a href="#BaseDiffusion.prompt_to_embedding-331"><span class="linenos">331</span></a>            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;use_attention_mask&quot;</span><span class="p">)</span>
</span><span id="BaseDiffusion.prompt_to_embedding-332"><a href="#BaseDiffusion.prompt_to_embedding-332"><span class="linenos">332</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_attention_mask</span>
</span><span id="BaseDiffusion.prompt_to_embedding-333"><a href="#BaseDiffusion.prompt_to_embedding-333"><span class="linenos">333</span></a>        <span class="p">):</span>
</span><span id="BaseDiffusion.prompt_to_embedding-334"><a href="#BaseDiffusion.prompt_to_embedding-334"><span class="linenos">334</span></a>            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">text_input</span><span class="o">.</span><span class="n">attention_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion.prompt_to_embedding-335"><a href="#BaseDiffusion.prompt_to_embedding-335"><span class="linenos">335</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion.prompt_to_embedding-336"><a href="#BaseDiffusion.prompt_to_embedding-336"><span class="linenos">336</span></a>            <span class="n">attention_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BaseDiffusion.prompt_to_embedding-337"><a href="#BaseDiffusion.prompt_to_embedding-337"><span class="linenos">337</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-338"><a href="#BaseDiffusion.prompt_to_embedding-338"><span class="linenos">338</span></a>        <span class="c1"># Generate text embedding</span>
</span><span id="BaseDiffusion.prompt_to_embedding-339"><a href="#BaseDiffusion.prompt_to_embedding-339"><span class="linenos">339</span></a>        <span class="n">text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span>
</span><span id="BaseDiffusion.prompt_to_embedding-340"><a href="#BaseDiffusion.prompt_to_embedding-340"><span class="linenos">340</span></a>            <span class="n">text_input</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span>
</span><span id="BaseDiffusion.prompt_to_embedding-341"><a href="#BaseDiffusion.prompt_to_embedding-341"><span class="linenos">341</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BaseDiffusion.prompt_to_embedding-342"><a href="#BaseDiffusion.prompt_to_embedding-342"><span class="linenos">342</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-343"><a href="#BaseDiffusion.prompt_to_embedding-343"><span class="linenos">343</span></a>        <span class="c1"># Unconditioning input is an empty string if negative_prompt is not provided</span>
</span><span id="BaseDiffusion.prompt_to_embedding-344"><a href="#BaseDiffusion.prompt_to_embedding-344"><span class="linenos">344</span></a>        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseDiffusion.prompt_to_embedding-345"><a href="#BaseDiffusion.prompt_to_embedding-345"><span class="linenos">345</span></a>            <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
</span><span id="BaseDiffusion.prompt_to_embedding-346"><a href="#BaseDiffusion.prompt_to_embedding-346"><span class="linenos">346</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion.prompt_to_embedding-347"><a href="#BaseDiffusion.prompt_to_embedding-347"><span class="linenos">347</span></a>            <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="n">negative_prompt</span>
</span><span id="BaseDiffusion.prompt_to_embedding-348"><a href="#BaseDiffusion.prompt_to_embedding-348"><span class="linenos">348</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-349"><a href="#BaseDiffusion.prompt_to_embedding-349"><span class="linenos">349</span></a>        <span class="c1"># Tokenize the unconditioning input</span>
</span><span id="BaseDiffusion.prompt_to_embedding-350"><a href="#BaseDiffusion.prompt_to_embedding-350"><span class="linenos">350</span></a>        <span class="n">unconditioning_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
</span><span id="BaseDiffusion.prompt_to_embedding-351"><a href="#BaseDiffusion.prompt_to_embedding-351"><span class="linenos">351</span></a>            <span class="n">unconditioning_input</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-352"><a href="#BaseDiffusion.prompt_to_embedding-352"><span class="linenos">352</span></a>            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-353"><a href="#BaseDiffusion.prompt_to_embedding-353"><span class="linenos">353</span></a>            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-354"><a href="#BaseDiffusion.prompt_to_embedding-354"><span class="linenos">354</span></a>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-355"><a href="#BaseDiffusion.prompt_to_embedding-355"><span class="linenos">355</span></a>            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-356"><a href="#BaseDiffusion.prompt_to_embedding-356"><span class="linenos">356</span></a>        <span class="p">)</span>
</span><span id="BaseDiffusion.prompt_to_embedding-357"><a href="#BaseDiffusion.prompt_to_embedding-357"><span class="linenos">357</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-358"><a href="#BaseDiffusion.prompt_to_embedding-358"><span class="linenos">358</span></a>        <span class="c1"># Generate unconditional embedding</span>
</span><span id="BaseDiffusion.prompt_to_embedding-359"><a href="#BaseDiffusion.prompt_to_embedding-359"><span class="linenos">359</span></a>        <span class="n">unconditional_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span>
</span><span id="BaseDiffusion.prompt_to_embedding-360"><a href="#BaseDiffusion.prompt_to_embedding-360"><span class="linenos">360</span></a>            <span class="n">unconditioning_input</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="BaseDiffusion.prompt_to_embedding-361"><a href="#BaseDiffusion.prompt_to_embedding-361"><span class="linenos">361</span></a>            <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
</span><span id="BaseDiffusion.prompt_to_embedding-362"><a href="#BaseDiffusion.prompt_to_embedding-362"><span class="linenos">362</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BaseDiffusion.prompt_to_embedding-363"><a href="#BaseDiffusion.prompt_to_embedding-363"><span class="linenos">363</span></a>
</span><span id="BaseDiffusion.prompt_to_embedding-364"><a href="#BaseDiffusion.prompt_to_embedding-364"><span class="linenos">364</span></a>        <span class="c1"># Concatenate unconditional and conditional embeddings</span>
</span><span id="BaseDiffusion.prompt_to_embedding-365"><a href="#BaseDiffusion.prompt_to_embedding-365"><span class="linenos">365</span></a>        <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">unconditional_embedding</span><span class="p">,</span> <span class="n">text_embedding</span><span class="p">])</span>
</span><span id="BaseDiffusion.prompt_to_embedding-366"><a href="#BaseDiffusion.prompt_to_embedding-366"><span class="linenos">366</span></a>        <span class="k">return</span> <span class="n">embedding</span>
</span></pre></div>


            <div class="docstring"><p>Convert a prompt or a list of prompts into a text embedding.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>prompt</strong> (PromptType):
The prompt or a list of prompts to convert into an embedding. Used
for conditioning.</li>
<li><strong>negative_prompt</strong> (Optional[PromptType]):
A negative prompt or a list of negative prompts, by default None.
Use for unconditioning. If not provided, an empty string ('') will
be used to generate the unconditional embeddings.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>torch.FloatTensor</strong>: A text embedding generated from the given prompt(s) and, if provided,
the negative prompt(s).</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.classifier_free_guidance" class="classattr">
                                        <input id="BaseDiffusion.classifier_free_guidance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">classifier_free_guidance</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">noise_prediction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span>,</span><span class="param">	<span class="n">guidance_scale</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">guidance_rescale</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.classifier_free_guidance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.classifier_free_guidance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.classifier_free_guidance-368"><a href="#BaseDiffusion.classifier_free_guidance-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">classifier_free_guidance</span><span class="p">(</span>
</span><span id="BaseDiffusion.classifier_free_guidance-369"><a href="#BaseDiffusion.classifier_free_guidance-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion.classifier_free_guidance-370"><a href="#BaseDiffusion.classifier_free_guidance-370"><span class="linenos">370</span></a>        <span class="n">noise_prediction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
</span><span id="BaseDiffusion.classifier_free_guidance-371"><a href="#BaseDiffusion.classifier_free_guidance-371"><span class="linenos">371</span></a>        <span class="n">guidance_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BaseDiffusion.classifier_free_guidance-372"><a href="#BaseDiffusion.classifier_free_guidance-372"><span class="linenos">372</span></a>        <span class="n">guidance_rescale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BaseDiffusion.classifier_free_guidance-373"><a href="#BaseDiffusion.classifier_free_guidance-373"><span class="linenos">373</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="BaseDiffusion.classifier_free_guidance-374"><a href="#BaseDiffusion.classifier_free_guidance-374"><span class="linenos">374</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.classifier_free_guidance-375"><a href="#BaseDiffusion.classifier_free_guidance-375"><span class="linenos">375</span></a><span class="sd">        Apply classifier-free guidance to noise prediction.</span>
</span><span id="BaseDiffusion.classifier_free_guidance-376"><a href="#BaseDiffusion.classifier_free_guidance-376"><span class="linenos">376</span></a>
</span><span id="BaseDiffusion.classifier_free_guidance-377"><a href="#BaseDiffusion.classifier_free_guidance-377"><span class="linenos">377</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.classifier_free_guidance-378"><a href="#BaseDiffusion.classifier_free_guidance-378"><span class="linenos">378</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.classifier_free_guidance-379"><a href="#BaseDiffusion.classifier_free_guidance-379"><span class="linenos">379</span></a><span class="sd">        noise_prediction: torch.FloatTensor</span>
</span><span id="BaseDiffusion.classifier_free_guidance-380"><a href="#BaseDiffusion.classifier_free_guidance-380"><span class="linenos">380</span></a><span class="sd">            The noise prediction tensor to which guidance will be applied.</span>
</span><span id="BaseDiffusion.classifier_free_guidance-381"><a href="#BaseDiffusion.classifier_free_guidance-381"><span class="linenos">381</span></a><span class="sd">        guidance_scale: float</span>
</span><span id="BaseDiffusion.classifier_free_guidance-382"><a href="#BaseDiffusion.classifier_free_guidance-382"><span class="linenos">382</span></a><span class="sd">            The scale factor for applying guidance to the noise prediction.</span>
</span><span id="BaseDiffusion.classifier_free_guidance-383"><a href="#BaseDiffusion.classifier_free_guidance-383"><span class="linenos">383</span></a><span class="sd">        guidance_rescale: float</span>
</span><span id="BaseDiffusion.classifier_free_guidance-384"><a href="#BaseDiffusion.classifier_free_guidance-384"><span class="linenos">384</span></a><span class="sd">            The rescale factor for adjusting the noise prediction based on</span>
</span><span id="BaseDiffusion.classifier_free_guidance-385"><a href="#BaseDiffusion.classifier_free_guidance-385"><span class="linenos">385</span></a><span class="sd">            guidance. Based on findings in Section 3.4  of [Common Diffusion</span>
</span><span id="BaseDiffusion.classifier_free_guidance-386"><a href="#BaseDiffusion.classifier_free_guidance-386"><span class="linenos">386</span></a><span class="sd">            Noise Schedules and Sample Steps are Flawed](https://arxiv.org/pdf/2305.08891.pdf).</span>
</span><span id="BaseDiffusion.classifier_free_guidance-387"><a href="#BaseDiffusion.classifier_free_guidance-387"><span class="linenos">387</span></a>
</span><span id="BaseDiffusion.classifier_free_guidance-388"><a href="#BaseDiffusion.classifier_free_guidance-388"><span class="linenos">388</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion.classifier_free_guidance-389"><a href="#BaseDiffusion.classifier_free_guidance-389"><span class="linenos">389</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion.classifier_free_guidance-390"><a href="#BaseDiffusion.classifier_free_guidance-390"><span class="linenos">390</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="BaseDiffusion.classifier_free_guidance-391"><a href="#BaseDiffusion.classifier_free_guidance-391"><span class="linenos">391</span></a><span class="sd">            The noise prediction tensor after applying classifier-free guidance.</span>
</span><span id="BaseDiffusion.classifier_free_guidance-392"><a href="#BaseDiffusion.classifier_free_guidance-392"><span class="linenos">392</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.classifier_free_guidance-393"><a href="#BaseDiffusion.classifier_free_guidance-393"><span class="linenos">393</span></a>
</span><span id="BaseDiffusion.classifier_free_guidance-394"><a href="#BaseDiffusion.classifier_free_guidance-394"><span class="linenos">394</span></a>        <span class="c1"># Perform guidance</span>
</span><span id="BaseDiffusion.classifier_free_guidance-395"><a href="#BaseDiffusion.classifier_free_guidance-395"><span class="linenos">395</span></a>        <span class="n">noise_unconditional</span><span class="p">,</span> <span class="n">noise_prompt</span> <span class="o">=</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="BaseDiffusion.classifier_free_guidance-396"><a href="#BaseDiffusion.classifier_free_guidance-396"><span class="linenos">396</span></a>        <span class="n">noise_prediction</span> <span class="o">=</span> <span class="n">noise_unconditional</span> <span class="o">+</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="p">(</span>
</span><span id="BaseDiffusion.classifier_free_guidance-397"><a href="#BaseDiffusion.classifier_free_guidance-397"><span class="linenos">397</span></a>            <span class="n">noise_prompt</span> <span class="o">-</span> <span class="n">noise_unconditional</span>
</span><span id="BaseDiffusion.classifier_free_guidance-398"><a href="#BaseDiffusion.classifier_free_guidance-398"><span class="linenos">398</span></a>        <span class="p">)</span>
</span><span id="BaseDiffusion.classifier_free_guidance-399"><a href="#BaseDiffusion.classifier_free_guidance-399"><span class="linenos">399</span></a>
</span><span id="BaseDiffusion.classifier_free_guidance-400"><a href="#BaseDiffusion.classifier_free_guidance-400"><span class="linenos">400</span></a>        <span class="c1"># Skip computing std if guidance_rescale is 0</span>
</span><span id="BaseDiffusion.classifier_free_guidance-401"><a href="#BaseDiffusion.classifier_free_guidance-401"><span class="linenos">401</span></a>        <span class="k">if</span> <span class="n">guidance_rescale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BaseDiffusion.classifier_free_guidance-402"><a href="#BaseDiffusion.classifier_free_guidance-402"><span class="linenos">402</span></a>            <span class="n">std_prompt</span> <span class="o">=</span> <span class="n">noise_prompt</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="BaseDiffusion.classifier_free_guidance-403"><a href="#BaseDiffusion.classifier_free_guidance-403"><span class="linenos">403</span></a>                <span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_prompt</span><span class="o">.</span><span class="n">ndim</span><span class="p">)),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span>
</span><span id="BaseDiffusion.classifier_free_guidance-404"><a href="#BaseDiffusion.classifier_free_guidance-404"><span class="linenos">404</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion.classifier_free_guidance-405"><a href="#BaseDiffusion.classifier_free_guidance-405"><span class="linenos">405</span></a>            <span class="n">std_prediction</span> <span class="o">=</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
</span><span id="BaseDiffusion.classifier_free_guidance-406"><a href="#BaseDiffusion.classifier_free_guidance-406"><span class="linenos">406</span></a>                <span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_prediction</span><span class="o">.</span><span class="n">ndim</span><span class="p">)),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span>
</span><span id="BaseDiffusion.classifier_free_guidance-407"><a href="#BaseDiffusion.classifier_free_guidance-407"><span class="linenos">407</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion.classifier_free_guidance-408"><a href="#BaseDiffusion.classifier_free_guidance-408"><span class="linenos">408</span></a>            <span class="n">noise_prediction_rescaled</span> <span class="o">=</span> <span class="n">noise_prediction</span> <span class="o">*</span> <span class="p">(</span><span class="n">std_prompt</span> <span class="o">/</span> <span class="n">std_prediction</span><span class="p">)</span>
</span><span id="BaseDiffusion.classifier_free_guidance-409"><a href="#BaseDiffusion.classifier_free_guidance-409"><span class="linenos">409</span></a>            <span class="n">noise_prediction</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseDiffusion.classifier_free_guidance-410"><a href="#BaseDiffusion.classifier_free_guidance-410"><span class="linenos">410</span></a>                <span class="n">noise_prediction</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">guidance_rescale</span><span class="p">)</span>
</span><span id="BaseDiffusion.classifier_free_guidance-411"><a href="#BaseDiffusion.classifier_free_guidance-411"><span class="linenos">411</span></a>                <span class="o">+</span> <span class="n">noise_prediction_rescaled</span> <span class="o">*</span> <span class="n">guidance_rescale</span>
</span><span id="BaseDiffusion.classifier_free_guidance-412"><a href="#BaseDiffusion.classifier_free_guidance-412"><span class="linenos">412</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion.classifier_free_guidance-413"><a href="#BaseDiffusion.classifier_free_guidance-413"><span class="linenos">413</span></a>
</span><span id="BaseDiffusion.classifier_free_guidance-414"><a href="#BaseDiffusion.classifier_free_guidance-414"><span class="linenos">414</span></a>        <span class="k">return</span> <span class="n">noise_prediction</span>
</span></pre></div>


            <div class="docstring"><p>Apply classifier-free guidance to noise prediction.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>noise_prediction</strong> (torch.FloatTensor):
The noise prediction tensor to which guidance will be applied.</li>
<li><strong>guidance_scale</strong> (float):
The scale factor for applying guidance to the noise prediction.</li>
<li><strong>guidance_rescale</strong> (float):
The rescale factor for adjusting the noise prediction based on
guidance. Based on findings in Section 3.4  of <a href="https://arxiv.org/pdf/2305.08891.pdf">Common Diffusion
Noise Schedules and Sample Steps are Flawed</a>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>torch.FloatTensor</strong>: The noise prediction tensor after applying classifier-free guidance.</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.latent_to_image" class="classattr">
                                        <input id="BaseDiffusion.latent_to_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">latent_to_image</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span>,</span><span class="param">	<span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.latent_to_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.latent_to_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.latent_to_image-416"><a href="#BaseDiffusion.latent_to_image-416"><span class="linenos">416</span></a>    <span class="k">def</span> <span class="nf">latent_to_image</span><span class="p">(</span>
</span><span id="BaseDiffusion.latent_to_image-417"><a href="#BaseDiffusion.latent_to_image-417"><span class="linenos">417</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="BaseDiffusion.latent_to_image-418"><a href="#BaseDiffusion.latent_to_image-418"><span class="linenos">418</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputType</span><span class="p">:</span>
</span><span id="BaseDiffusion.latent_to_image-419"><a href="#BaseDiffusion.latent_to_image-419"><span class="linenos">419</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.latent_to_image-420"><a href="#BaseDiffusion.latent_to_image-420"><span class="linenos">420</span></a><span class="sd">        Convert a latent tensor to an image in the specified output format.</span>
</span><span id="BaseDiffusion.latent_to_image-421"><a href="#BaseDiffusion.latent_to_image-421"><span class="linenos">421</span></a>
</span><span id="BaseDiffusion.latent_to_image-422"><a href="#BaseDiffusion.latent_to_image-422"><span class="linenos">422</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.latent_to_image-423"><a href="#BaseDiffusion.latent_to_image-423"><span class="linenos">423</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.latent_to_image-424"><a href="#BaseDiffusion.latent_to_image-424"><span class="linenos">424</span></a><span class="sd">        latent: torch.FloatTensor</span>
</span><span id="BaseDiffusion.latent_to_image-425"><a href="#BaseDiffusion.latent_to_image-425"><span class="linenos">425</span></a><span class="sd">            The latent tensor to convert into an image.</span>
</span><span id="BaseDiffusion.latent_to_image-426"><a href="#BaseDiffusion.latent_to_image-426"><span class="linenos">426</span></a><span class="sd">        output_type: str</span>
</span><span id="BaseDiffusion.latent_to_image-427"><a href="#BaseDiffusion.latent_to_image-427"><span class="linenos">427</span></a><span class="sd">            The desired output format for the image. Should be one of [`pt`, `np`, `pil`].</span>
</span><span id="BaseDiffusion.latent_to_image-428"><a href="#BaseDiffusion.latent_to_image-428"><span class="linenos">428</span></a>
</span><span id="BaseDiffusion.latent_to_image-429"><a href="#BaseDiffusion.latent_to_image-429"><span class="linenos">429</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion.latent_to_image-430"><a href="#BaseDiffusion.latent_to_image-430"><span class="linenos">430</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion.latent_to_image-431"><a href="#BaseDiffusion.latent_to_image-431"><span class="linenos">431</span></a><span class="sd">        OutputType</span>
</span><span id="BaseDiffusion.latent_to_image-432"><a href="#BaseDiffusion.latent_to_image-432"><span class="linenos">432</span></a><span class="sd">            An image in the specified output format.</span>
</span><span id="BaseDiffusion.latent_to_image-433"><a href="#BaseDiffusion.latent_to_image-433"><span class="linenos">433</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.latent_to_image-434"><a href="#BaseDiffusion.latent_to_image-434"><span class="linenos">434</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;pil&quot;</span><span class="p">]:</span>
</span><span id="BaseDiffusion.latent_to_image-435"><a href="#BaseDiffusion.latent_to_image-435"><span class="linenos">435</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`output_type` must be one of [`pt`, `np`, `pil`]&quot;</span><span class="p">)</span>
</span><span id="BaseDiffusion.latent_to_image-436"><a href="#BaseDiffusion.latent_to_image-436"><span class="linenos">436</span></a>
</span><span id="BaseDiffusion.latent_to_image-437"><a href="#BaseDiffusion.latent_to_image-437"><span class="linenos">437</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span id="BaseDiffusion.latent_to_image-438"><a href="#BaseDiffusion.latent_to_image-438"><span class="linenos">438</span></a>            <span class="n">latent</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span>
</span><span id="BaseDiffusion.latent_to_image-439"><a href="#BaseDiffusion.latent_to_image-439"><span class="linenos">439</span></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BaseDiffusion.latent_to_image-440"><a href="#BaseDiffusion.latent_to_image-440"><span class="linenos">440</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion.latent_to_image-441"><a href="#BaseDiffusion.latent_to_image-441"><span class="linenos">441</span></a>
</span><span id="BaseDiffusion.latent_to_image-442"><a href="#BaseDiffusion.latent_to_image-442"><span class="linenos">442</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;pt&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion.latent_to_image-443"><a href="#BaseDiffusion.latent_to_image-443"><span class="linenos">443</span></a>            <span class="k">return</span> <span class="n">image</span>
</span><span id="BaseDiffusion.latent_to_image-444"><a href="#BaseDiffusion.latent_to_image-444"><span class="linenos">444</span></a>
</span><span id="BaseDiffusion.latent_to_image-445"><a href="#BaseDiffusion.latent_to_image-445"><span class="linenos">445</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion.latent_to_image-446"><a href="#BaseDiffusion.latent_to_image-446"><span class="linenos">446</span></a>
</span><span id="BaseDiffusion.latent_to_image-447"><a href="#BaseDiffusion.latent_to_image-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion.latent_to_image-448"><a href="#BaseDiffusion.latent_to_image-448"><span class="linenos">448</span></a>            <span class="k">return</span> <span class="n">image</span>
</span><span id="BaseDiffusion.latent_to_image-449"><a href="#BaseDiffusion.latent_to_image-449"><span class="linenos">449</span></a>
</span><span id="BaseDiffusion.latent_to_image-450"><a href="#BaseDiffusion.latent_to_image-450"><span class="linenos">450</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">numpy_to_pil</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion.latent_to_image-451"><a href="#BaseDiffusion.latent_to_image-451"><span class="linenos">451</span></a>        <span class="k">return</span> <span class="n">image</span>
</span></pre></div>


            <div class="docstring"><p>Convert a latent tensor to an image in the specified output format.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>latent</strong> (torch.FloatTensor):
The latent tensor to convert into an image.</li>
<li><strong>output_type</strong> (str):
The desired output format for the image. Should be one of [<code>pt</code>, <code>np</code>, <code>pil</code>].</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>OutputType</strong>: An image in the specified output format.</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.image_to_latent" class="classattr">
                                        <input id="BaseDiffusion.image_to_latent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">image_to_latent</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.image_to_latent-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.image_to_latent"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.image_to_latent-453"><a href="#BaseDiffusion.image_to_latent-453"><span class="linenos">453</span></a>    <span class="k">def</span> <span class="nf">image_to_latent</span><span class="p">(</span>
</span><span id="BaseDiffusion.image_to_latent-454"><a href="#BaseDiffusion.image_to_latent-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion.image_to_latent-455"><a href="#BaseDiffusion.image_to_latent-455"><span class="linenos">455</span></a>        <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
</span><span id="BaseDiffusion.image_to_latent-456"><a href="#BaseDiffusion.image_to_latent-456"><span class="linenos">456</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span id="BaseDiffusion.image_to_latent-457"><a href="#BaseDiffusion.image_to_latent-457"><span class="linenos">457</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.image_to_latent-458"><a href="#BaseDiffusion.image_to_latent-458"><span class="linenos">458</span></a><span class="sd">        Convert an image or a list of images into a latent tensor.</span>
</span><span id="BaseDiffusion.image_to_latent-459"><a href="#BaseDiffusion.image_to_latent-459"><span class="linenos">459</span></a>
</span><span id="BaseDiffusion.image_to_latent-460"><a href="#BaseDiffusion.image_to_latent-460"><span class="linenos">460</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.image_to_latent-461"><a href="#BaseDiffusion.image_to_latent-461"><span class="linenos">461</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.image_to_latent-462"><a href="#BaseDiffusion.image_to_latent-462"><span class="linenos">462</span></a><span class="sd">        image: Union[Image.Image, List[Image.Image], np.ndarray, torch.Tensor]</span>
</span><span id="BaseDiffusion.image_to_latent-463"><a href="#BaseDiffusion.image_to_latent-463"><span class="linenos">463</span></a><span class="sd">            The input image(s) to convert into a latent tensor. Supported types are</span>
</span><span id="BaseDiffusion.image_to_latent-464"><a href="#BaseDiffusion.image_to_latent-464"><span class="linenos">464</span></a><span class="sd">            `PIL.Image.Image`, `np.ndarray`, and `torch.Tensor`.</span>
</span><span id="BaseDiffusion.image_to_latent-465"><a href="#BaseDiffusion.image_to_latent-465"><span class="linenos">465</span></a>
</span><span id="BaseDiffusion.image_to_latent-466"><a href="#BaseDiffusion.image_to_latent-466"><span class="linenos">466</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion.image_to_latent-467"><a href="#BaseDiffusion.image_to_latent-467"><span class="linenos">467</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion.image_to_latent-468"><a href="#BaseDiffusion.image_to_latent-468"><span class="linenos">468</span></a><span class="sd">        torch.FloatTensor</span>
</span><span id="BaseDiffusion.image_to_latent-469"><a href="#BaseDiffusion.image_to_latent-469"><span class="linenos">469</span></a><span class="sd">            A latent tensor representing the input image(s).</span>
</span><span id="BaseDiffusion.image_to_latent-470"><a href="#BaseDiffusion.image_to_latent-470"><span class="linenos">470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.image_to_latent-471"><a href="#BaseDiffusion.image_to_latent-471"><span class="linenos">471</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="BaseDiffusion.image_to_latent-472"><a href="#BaseDiffusion.image_to_latent-472"><span class="linenos">472</span></a>            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-473"><a href="#BaseDiffusion.image_to_latent-473"><span class="linenos">473</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-474"><a href="#BaseDiffusion.image_to_latent-474"><span class="linenos">474</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-475"><a href="#BaseDiffusion.image_to_latent-475"><span class="linenos">475</span></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-476"><a href="#BaseDiffusion.image_to_latent-476"><span class="linenos">476</span></a>        <span class="p">):</span>
</span><span id="BaseDiffusion.image_to_latent-477"><a href="#BaseDiffusion.image_to_latent-477"><span class="linenos">477</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="BaseDiffusion.image_to_latent-478"><a href="#BaseDiffusion.image_to_latent-478"><span class="linenos">478</span></a>                <span class="s2">&quot;`image` type must be one of (`PIL.Image.Image`, `np.ndarray`, `torch.Tensor`). Other types are not supported yet&quot;</span>
</span><span id="BaseDiffusion.image_to_latent-479"><a href="#BaseDiffusion.image_to_latent-479"><span class="linenos">479</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-480"><a href="#BaseDiffusion.image_to_latent-480"><span class="linenos">480</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
</span><span id="BaseDiffusion.image_to_latent-481"><a href="#BaseDiffusion.image_to_latent-481"><span class="linenos">481</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span>
</span><span id="BaseDiffusion.image_to_latent-482"><a href="#BaseDiffusion.image_to_latent-482"><span class="linenos">482</span></a>
</span><span id="BaseDiffusion.image_to_latent-483"><a href="#BaseDiffusion.image_to_latent-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
</span><span id="BaseDiffusion.image_to_latent-484"><a href="#BaseDiffusion.image_to_latent-484"><span class="linenos">484</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">pil_to_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-485"><a href="#BaseDiffusion.image_to_latent-485"><span class="linenos">485</span></a>
</span><span id="BaseDiffusion.image_to_latent-486"><a href="#BaseDiffusion.image_to_latent-486"><span class="linenos">486</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="BaseDiffusion.image_to_latent-487"><a href="#BaseDiffusion.image_to_latent-487"><span class="linenos">487</span></a>            <span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span> <span class="o">=</span> <span class="n">numpy_to_pt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-488"><a href="#BaseDiffusion.image_to_latent-488"><span class="linenos">488</span></a>
</span><span id="BaseDiffusion.image_to_latent-489"><a href="#BaseDiffusion.image_to_latent-489"><span class="linenos">489</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-490"><a href="#BaseDiffusion.image_to_latent-490"><span class="linenos">490</span></a>        <span class="n">latent</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseDiffusion.image_to_latent-491"><a href="#BaseDiffusion.image_to_latent-491"><span class="linenos">491</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">latent_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span>
</span><span id="BaseDiffusion.image_to_latent-492"><a href="#BaseDiffusion.image_to_latent-492"><span class="linenos">492</span></a>        <span class="p">)</span>
</span><span id="BaseDiffusion.image_to_latent-493"><a href="#BaseDiffusion.image_to_latent-493"><span class="linenos">493</span></a>
</span><span id="BaseDiffusion.image_to_latent-494"><a href="#BaseDiffusion.image_to_latent-494"><span class="linenos">494</span></a>        <span class="k">return</span> <span class="n">latent</span>
</span></pre></div>


            <div class="docstring"><p>Convert an image or a list of images into a latent tensor.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>image</strong> (Union[Image.Image, List[Image.Image], np.ndarray, torch.Tensor]):
The input image(s) to convert into a latent tensor. Supported types are
<code>PIL.Image.Image</code>, <code>np.ndarray</code>, and <code>torch.Tensor</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>torch.FloatTensor</strong>: A latent tensor representing the input image(s).</li>
</ul>
</div>


                            </div>
                            <div id="BaseDiffusion.resolve_output" class="classattr">
                                        <input id="BaseDiffusion.resolve_output-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">resolve_output</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span>,</span><span class="param">	<span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">return_latent_history</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]]]]</span>:</span></span>

                <label class="view-source-button" for="BaseDiffusion.resolve_output-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseDiffusion.resolve_output"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseDiffusion.resolve_output-496"><a href="#BaseDiffusion.resolve_output-496"><span class="linenos">496</span></a>    <span class="k">def</span> <span class="nf">resolve_output</span><span class="p">(</span>
</span><span id="BaseDiffusion.resolve_output-497"><a href="#BaseDiffusion.resolve_output-497"><span class="linenos">497</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseDiffusion.resolve_output-498"><a href="#BaseDiffusion.resolve_output-498"><span class="linenos">498</span></a>        <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
</span><span id="BaseDiffusion.resolve_output-499"><a href="#BaseDiffusion.resolve_output-499"><span class="linenos">499</span></a>        <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BaseDiffusion.resolve_output-500"><a href="#BaseDiffusion.resolve_output-500"><span class="linenos">500</span></a>        <span class="n">return_latent_history</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="BaseDiffusion.resolve_output-501"><a href="#BaseDiffusion.resolve_output-501"><span class="linenos">501</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">OutputType</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputType</span><span class="p">]]:</span>
</span><span id="BaseDiffusion.resolve_output-502"><a href="#BaseDiffusion.resolve_output-502"><span class="linenos">502</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.resolve_output-503"><a href="#BaseDiffusion.resolve_output-503"><span class="linenos">503</span></a><span class="sd">        Resolve the output from the latent based on the provided output options.</span>
</span><span id="BaseDiffusion.resolve_output-504"><a href="#BaseDiffusion.resolve_output-504"><span class="linenos">504</span></a>
</span><span id="BaseDiffusion.resolve_output-505"><a href="#BaseDiffusion.resolve_output-505"><span class="linenos">505</span></a><span class="sd">        Parameters</span>
</span><span id="BaseDiffusion.resolve_output-506"><a href="#BaseDiffusion.resolve_output-506"><span class="linenos">506</span></a><span class="sd">        ----------</span>
</span><span id="BaseDiffusion.resolve_output-507"><a href="#BaseDiffusion.resolve_output-507"><span class="linenos">507</span></a><span class="sd">        latent: torch.FloatTensor</span>
</span><span id="BaseDiffusion.resolve_output-508"><a href="#BaseDiffusion.resolve_output-508"><span class="linenos">508</span></a><span class="sd">            The latent tensor representing the content to be resolved.</span>
</span><span id="BaseDiffusion.resolve_output-509"><a href="#BaseDiffusion.resolve_output-509"><span class="linenos">509</span></a><span class="sd">        output_type: str</span>
</span><span id="BaseDiffusion.resolve_output-510"><a href="#BaseDiffusion.resolve_output-510"><span class="linenos">510</span></a><span class="sd">            The desired output format. Should be one of [`latent`, `pt`, `np`, `pil`].</span>
</span><span id="BaseDiffusion.resolve_output-511"><a href="#BaseDiffusion.resolve_output-511"><span class="linenos">511</span></a><span class="sd">        return_latent_history: bool</span>
</span><span id="BaseDiffusion.resolve_output-512"><a href="#BaseDiffusion.resolve_output-512"><span class="linenos">512</span></a><span class="sd">            If True, it means that the input latent tensor contains a tensor of latent</span>
</span><span id="BaseDiffusion.resolve_output-513"><a href="#BaseDiffusion.resolve_output-513"><span class="linenos">513</span></a><span class="sd">            tensor for each inference step. This requires decoding each latent tensor</span>
</span><span id="BaseDiffusion.resolve_output-514"><a href="#BaseDiffusion.resolve_output-514"><span class="linenos">514</span></a><span class="sd">            and returning a list of images. If False, decoding occurs directly.</span>
</span><span id="BaseDiffusion.resolve_output-515"><a href="#BaseDiffusion.resolve_output-515"><span class="linenos">515</span></a>
</span><span id="BaseDiffusion.resolve_output-516"><a href="#BaseDiffusion.resolve_output-516"><span class="linenos">516</span></a><span class="sd">        Returns</span>
</span><span id="BaseDiffusion.resolve_output-517"><a href="#BaseDiffusion.resolve_output-517"><span class="linenos">517</span></a><span class="sd">        -------</span>
</span><span id="BaseDiffusion.resolve_output-518"><a href="#BaseDiffusion.resolve_output-518"><span class="linenos">518</span></a><span class="sd">        Union[OutputType, List[OutputType]]</span>
</span><span id="BaseDiffusion.resolve_output-519"><a href="#BaseDiffusion.resolve_output-519"><span class="linenos">519</span></a><span class="sd">            The resolved output based on the provided latent vector and options.</span>
</span><span id="BaseDiffusion.resolve_output-520"><a href="#BaseDiffusion.resolve_output-520"><span class="linenos">520</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseDiffusion.resolve_output-521"><a href="#BaseDiffusion.resolve_output-521"><span class="linenos">521</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;latent&quot;</span><span class="p">,</span> <span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="s2">&quot;pil&quot;</span><span class="p">]:</span>
</span><span id="BaseDiffusion.resolve_output-522"><a href="#BaseDiffusion.resolve_output-522"><span class="linenos">522</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseDiffusion.resolve_output-523"><a href="#BaseDiffusion.resolve_output-523"><span class="linenos">523</span></a>                <span class="s2">&quot;`output_type` must be one of [`latent`, `pt`, `np`, `pil`]&quot;</span>
</span><span id="BaseDiffusion.resolve_output-524"><a href="#BaseDiffusion.resolve_output-524"><span class="linenos">524</span></a>            <span class="p">)</span>
</span><span id="BaseDiffusion.resolve_output-525"><a href="#BaseDiffusion.resolve_output-525"><span class="linenos">525</span></a>
</span><span id="BaseDiffusion.resolve_output-526"><a href="#BaseDiffusion.resolve_output-526"><span class="linenos">526</span></a>        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion.resolve_output-527"><a href="#BaseDiffusion.resolve_output-527"><span class="linenos">527</span></a>            <span class="k">return</span> <span class="n">latent</span>
</span><span id="BaseDiffusion.resolve_output-528"><a href="#BaseDiffusion.resolve_output-528"><span class="linenos">528</span></a>
</span><span id="BaseDiffusion.resolve_output-529"><a href="#BaseDiffusion.resolve_output-529"><span class="linenos">529</span></a>        <span class="k">if</span> <span class="n">return_latent_history</span><span class="p">:</span>
</span><span id="BaseDiffusion.resolve_output-530"><a href="#BaseDiffusion.resolve_output-530"><span class="linenos">530</span></a>            <span class="c1"># Transpose latent tensor from [num_steps, batch_size, *latent_dim] to</span>
</span><span id="BaseDiffusion.resolve_output-531"><a href="#BaseDiffusion.resolve_output-531"><span class="linenos">531</span></a>            <span class="c1"># [batch_size, num_steps, *latent_dim].</span>
</span><span id="BaseDiffusion.resolve_output-532"><a href="#BaseDiffusion.resolve_output-532"><span class="linenos">532</span></a>            <span class="c1"># This is done so that the history of latent vectors for each prompt</span>
</span><span id="BaseDiffusion.resolve_output-533"><a href="#BaseDiffusion.resolve_output-533"><span class="linenos">533</span></a>            <span class="c1"># is returned as a row instead of a column. It is what the user would</span>
</span><span id="BaseDiffusion.resolve_output-534"><a href="#BaseDiffusion.resolve_output-534"><span class="linenos">534</span></a>            <span class="c1"># intuitively expect.</span>
</span><span id="BaseDiffusion.resolve_output-535"><a href="#BaseDiffusion.resolve_output-535"><span class="linenos">535</span></a>            <span class="n">latent</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseDiffusion.resolve_output-536"><a href="#BaseDiffusion.resolve_output-536"><span class="linenos">536</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="BaseDiffusion.resolve_output-537"><a href="#BaseDiffusion.resolve_output-537"><span class="linenos">537</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latent_to_image</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">output_type</span><span class="p">)</span>
</span><span id="BaseDiffusion.resolve_output-538"><a href="#BaseDiffusion.resolve_output-538"><span class="linenos">538</span></a>                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">latent</span><span class="p">)))</span>
</span><span id="BaseDiffusion.resolve_output-539"><a href="#BaseDiffusion.resolve_output-539"><span class="linenos">539</span></a>            <span class="p">]</span>
</span><span id="BaseDiffusion.resolve_output-540"><a href="#BaseDiffusion.resolve_output-540"><span class="linenos">540</span></a>
</span><span id="BaseDiffusion.resolve_output-541"><a href="#BaseDiffusion.resolve_output-541"><span class="linenos">541</span></a>            <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;pt&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion.resolve_output-542"><a href="#BaseDiffusion.resolve_output-542"><span class="linenos">542</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion.resolve_output-543"><a href="#BaseDiffusion.resolve_output-543"><span class="linenos">543</span></a>            <span class="k">elif</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
</span><span id="BaseDiffusion.resolve_output-544"><a href="#BaseDiffusion.resolve_output-544"><span class="linenos">544</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="BaseDiffusion.resolve_output-545"><a href="#BaseDiffusion.resolve_output-545"><span class="linenos">545</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion.resolve_output-546"><a href="#BaseDiffusion.resolve_output-546"><span class="linenos">546</span></a>                <span class="c1"># output type is &quot;pil&quot; so we can just return as a python list</span>
</span><span id="BaseDiffusion.resolve_output-547"><a href="#BaseDiffusion.resolve_output-547"><span class="linenos">547</span></a>                <span class="k">pass</span>
</span><span id="BaseDiffusion.resolve_output-548"><a href="#BaseDiffusion.resolve_output-548"><span class="linenos">548</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseDiffusion.resolve_output-549"><a href="#BaseDiffusion.resolve_output-549"><span class="linenos">549</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_to_image</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="n">output_type</span><span class="p">)</span>
</span><span id="BaseDiffusion.resolve_output-550"><a href="#BaseDiffusion.resolve_output-550"><span class="linenos">550</span></a>
</span><span id="BaseDiffusion.resolve_output-551"><a href="#BaseDiffusion.resolve_output-551"><span class="linenos">551</span></a>        <span class="k">return</span> <span class="n">image</span>
</span></pre></div>


            <div class="docstring"><p>Resolve the output from the latent based on the provided output options.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>latent</strong> (torch.FloatTensor):
The latent tensor representing the content to be resolved.</li>
<li><strong>output_type</strong> (str):
The desired output format. Should be one of [<code>latent</code>, <code>pt</code>, <code>np</code>, <code>pil</code>].</li>
<li><strong>return_latent_history</strong> (bool):
If True, it means that the input latent tensor contains a tensor of latent
tensor for each inference step. This requires decoding each latent tensor
and returning a list of images. If False, decoding occurs directly.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>Union[OutputType, List[OutputType]]</strong>: The resolved output based on the provided latent vector and options.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>